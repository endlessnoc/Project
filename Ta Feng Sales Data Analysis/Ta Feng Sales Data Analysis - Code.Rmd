---
title: "TaFeng_Sales_Data_Analysis"
author: "G11, NSYSU"
date: "`r Sys.time()`"
output:
  html_document:
    highlight: pygments
    theme: flatly
    css: ../etc/style.css
  pdf_document: default
---
<br>

### è³‡æ–™å½™æ•´æµç¨‹

<center>
![Fig-1:äº¤æ˜“è³‡æ–™å½™æ•´](fig/aggregation.jpg)
</center>

<hr>

### 1. è¼‰å…¥å¥—ä»¶èˆ‡è³‡æ–™ Importing Libraries and Loading Data

```{r echo=T, message=F, cache=F, warning=F}
#è¼‰å…¥å¥—ä»¶
rm(list=ls(all=T))
pacman::p_load(magrittr, readr, caTools, ggplot2, dplyr, vcd, plotly,tidyr, gridExtra, reshape2, heatmaply,morpheus)
```

```{r}
#è®€é€²è³‡æ–™
df = read_csv("data/ta_feng_all_months_merged.csv") %>% 
     data.frame %>% 
     setNames(c("date","cust","age","area","cat","prod","qty","cost","price"))
head(df)
```

### 2.è³‡æ–™é è™•ç† Data Preprocessing

```{r}
#è³‡æ–™çµæ§‹
str(df)
```

```{r}
#è³‡æ–™å”¯ä¸€å€¼æ•¸é‡ / Checking Unique Values
col_list = colnames(df)
unique_counts = list()

for (col in col_list) {
  unique_count = length(unique(df[[col]]))  
  unique_counts[[col]] = unique_count
}

for (col in col_list) {  
  cat("Column", col, "has", unique_counts[[col]], "unique values.\n")
}

```


```{r}
#æ—¥æœŸæ ¼å¼è½‰æ›ã€å¹´é½¡å±¤ç´šèˆ‡éƒµéå€è™Ÿæ•´ç†
df$date = as.Date(df$date, format="%m/%d/%Y")
age.group = c("<25","25-29","30-34","35-39","40-44",
              "45-49","50-54","55-59","60-64",">65")
df$age = c(paste0("u",seq(24,69,5)),"none")[match(df$age,age.group,11)]
df$area = paste0("z",df$area)
head(df)
```
Area Code: 105=æ¾å±±å€ã€106=å¤§å®‰å€ã€110=ä¿¡ç¾©å€ã€114=å…§æ¹–å€ã€115=å—æ¸¯å€ã€221=æ±æ­¢å¸‚ã€Others=å…¶ä»–ã€Unknown=æœªçŸ¥<br>


```{r}
#æª¢è¦–æ•¸é‡ã€æˆæœ¬ã€å”®åƒ¹åˆ†å¸ƒç‹€æ³
par(mfrow=c(1,3),cex=0.7)
hist(df$qty, main = "Qty Histogram", xlab = "Quantity", ylab = "Freq", col = "lightblue")
hist(df$cost, main = "Cost Histogram", xlab = "Cost", ylab = "Freqy", col = "lightgreen")
hist(df$price, main = "Price Histogram", xlab = "Price", ylab = "Freq", col = "lightcoral")
#å¯è¦‹ä¸‰è€…è³‡æ–™éƒ½æ˜¯æ¥µç«¯å³ååˆ†å¸ƒï¼Œä¸”ç„¡è² å€¼
```

```{r}
#æŸ¥çœ‹æ•¸æ“šæ¥µå¤§å€¼
apply(df[,7:9], 2, max)
```

```{r}
#å®šç¾©é›¢ç¾¤å€¼
sapply(df[,7:9], quantile, prob=c(.99, .999, .9995))
```

```{r}
#ç§»é™¤é›¢ç¾¤å€¼ Remove Outliers
df = subset(df, qty<=24 & cost<=3800 & price<=4000) 
nrow(df)  
```

```{r}
#æ ¹æ“šæ—¥æœŸå’Œå®¢äººå½™ç¸½è¨‚å–® / Agrregate by Date & Customer
df$tid = group_indices(df, date, cust)
```

```{r}
#æª¢è¦–å½™ç¸½å¾Œçš„No. cust, cat, prod, tidå”¯ä¸€å€¼ / Unique Values
sapply(df[c("cust","cat","prod","tid")], n_distinct)
```

```{r}
#æ ¹æ“šå‰è¿°åˆ†å¥½çš„tidï¼Œå½™æ•´å‡ºéœ€è¦çš„è³‡æ–™
X = df %>% group_by(tid) %>% 
  summarise(
    date = min(date),          # äº¤æ˜“æ—¥æœŸ  
    cust = min(cust),          # é¡§å®¢ ID
    age = min(age),            # é¡§å®¢ å¹´é½¡ç´šåˆ¥
    area = min(area),          # é¡§å®¢ å±…ä½å€åˆ¥
    items = n(),               # äº¤æ˜“é …ç›®(ç¸½)æ•¸
    pieces = sum(qty),         # ç”¢å“(ç¸½)ä»¶æ•¸
    total = sum(price),        # äº¤æ˜“(ç¸½)é‡‘é¡
    gross = sum(price - cost)  # æ¯›åˆ©
) %>% data.frame
nrow(X)  
```


```{r}
#å½™æ•´å¾Œè³‡æ–™æ¦‚è¦½
summary(X)
#æ¯›åˆ©æœ‰è² ï¼Œä»£è¡¨ä¸¦ééƒ½æ˜¯è³ºéŒ¢
```


```{r}
# å®šç¾©é›¢ç¾¤å€¼
sapply(X[,6:9], quantile, prob=c(.999, .9995, .9999))
```

```{r}
# ç§»é™¤é›¢ç¾¤å€¼ / Remove Outliers
X = subset(X, items<=62 & pieces<95 & total<16000) 
nrow(X)
```


```{r}
#å°‡XæŒ‰ç…§Custé€²è¡Œåˆ†çµ„ï¼Œç„¶å¾Œå°æ¯å€‹å®¢æˆ¶çš„æ•¸æ“šé€²è¡Œæ‘˜è¦çµ±è¨ˆã€‚=
#rï¼ˆæœ€è¿‘è³¼è²·çš„å¤©æ•¸ï¼‰
#sï¼ˆè³¼è²·æ­·å²æœ€æ—©çš„å¤©æ•¸ï¼‰
#fï¼ˆè³¼è²·æ¬¡æ•¸ï¼‰
#mï¼ˆå¹³å‡æ¯æ¬¡è³¼è²·é‡‘é¡ï¼‰
#revï¼ˆç¸½æ”¶å…¥è²¢ç»ï¼‰
#rawï¼ˆç¸½æ¯›åˆ©è²¢ç»ï¼‰
#ageï¼ˆå¹´é½¡çµ„åˆ¥ï¼‰
#areaï¼ˆåœ°å€ä»£è™Ÿï¼‰
d0 = max(X$date) + 1
A = X %>% mutate(
  days = as.integer(difftime(d0, date, units="days"))) %>% 
    group_by(cust) %>% 
      summarize(
        r = min(days),      # recency
        s = max(days),      # seniority
        f = n(),            # frquency
        m = round(mean(total)),    # monetary
        rev = sum(total),   # total revenue contribution
        raw = sum(gross),   # total gross profit contribution
        age = min(age),     # age group
        area = min(area),   # area code
  ) %>% 
    data.frame      
nrow(A) # å…±æœ‰32241å€‹å®¢æˆ¶çš„ç´€éŒ„
```

åˆ°ç›®å‰ï¼Œdfç‚ºå¼•å…¥çš„åŸå§‹è³‡æ–™ï¼ŒXå‰‡ç‚ºæ ¹æ“šæ—¥æœŸã€å®¢äººæ•´ç†éçš„è³‡æ–™ï¼ŒAå‰‡ç‚ºå¾Xä¸­å†è¨ˆç®—å¾—å‡ºçš„æ•¸æ“šæŒ‡æ¨™è³‡æ–™<br>


### 3.æ¢ç´¢æ€§è³‡æ–™åˆ†æèˆ‡è¦–è¦ºåŒ– Exploratory Data Analysis

#### è³‡æ–™åˆ†å¸ƒ Data Distribution

```{r fig.height=8}
#å°Aä¸­æ¯æ¬„è³‡æ–™åšè³‡æ–™åˆ†å¸ƒè¦–è¦ºåŒ–
par(mfrow=c(4,2), mar=c(3,3,4,2))
col_list1 = c("r","s","f","m","rev","raw")
col_list2 = c("age","area")
for (col in col_list1) {
  hist(A[,col],freq=T,main=paste("Distribution by", col),xlab=paste(col),ylab="",cex.main=2)
}
for (col in col_list2) {
  table(A[col],useNA="ifany") %>% 
    barplot(main=paste("Distribution by", col), las=2, xlab = paste(col))
}

```

å¯ä»¥çœ‹å‡ºè³¼è²·é »ç‡ã€æœ€è¿‘è³¼è²·çš„å¤©æ•¸ã€å¹³å‡æ¯æ¬¡è³¼è²·é‡‘é¡ã€ç¸½æ”¶å…¥è²¢ç»ã€ç¸½æ¯›åˆ©éƒ½å‘ˆç¾å³ååˆ†å¸ƒ<br>
è€Œè³¼è²·æ­·å²æœ€æ—©çš„å¤©æ•¸å‰‡ç‚ºå·¦ååˆ†å¸ƒ<br>
å¹´é½¡çš„åˆ†ä½ˆå‰‡ä»¥30-39ç‚ºå¤šæ•¸ï¼Œå…©å´é€æ¼¸éæ¸›ï¼›åœ°å€å‰‡æ˜¯z115å’Œz221æ˜é¡¯è¼ƒå¤š<br>


#### å¹´é½¡å’Œåœ°å€åˆ†ç¾¤åˆ†æ Age/Area Segmentation

```{r} 
#ä¾æ“šå¹´é½¡å’Œåœ°å€ï¼Œå°å…¶ä»–æ¬„åšæ¯”è¼ƒ
#è³‡æ–™çµæ§‹è™•ç†
linear_data <- A[, c('r', 'f', 'm', 'rev', 'raw')]
A$age_1 = as.character(A$age)
A$area_1 = as.character(A$area)

age = as.numeric(sub("u", "", A$age_1))
area = as.numeric(sub("z","", A$area_1))

combined_data = cbind(linear_data, age,area)
unique(combined_data$age)
unique(combined_data$area)
combined_data$age = as.factor(combined_data$age)
combined_data$area = as.factor(combined_data$area)

dim(combined_data)

```

```{r}
#ä¾æ“šå¹´é½¡æ•´åˆæ‰€éœ€è³‡æ–™
grouped_data_age = aggregate(. ~ age, data = combined_data, FUN = mean) 
grouped_data_age = grouped_data_age[,-7]
print(grouped_data_age)
```

```{r}
#ä¾æ“šåœ°å€æ•´åˆæ‰€éœ€è³‡æ–™
grouped_data_area = aggregate(. ~ area, data = combined_data, FUN = mean) 
grouped_data_area = grouped_data_area[,-7]
print(grouped_data_area)
```


```{r fig.height=10, fig.width=10}
#å°‡æ•´ç†å¥½çš„è³‡æ–™by age åšè¦–è¦ºåŒ–
melted_data_age = melt(grouped_data_age, id.vars = "age")

v = ggplot(melted_data_age, aes(x = age, y = value, fill = variable)) +
  geom_bar(stat = "identity", position = "dodge", width = 0.5) +
  labs(title = "ä¸åŒå¹´é½¡ç´šè·çš„åƒæ•¸åˆ†å¸ƒ", y = "å¹³å‡å€¼", x="å¹´é½¡") +
  theme_minimal() +
  facet_wrap(~variable, scales = "free_y", ncol = 1)
ggplotly(v)
```
å¯ä»¥çœ‹å‡º30-49æ­²ç‚ºæ·¨åˆ©èˆ‡ç²åˆ©è²¢ç»æœ€æ˜é¡¯çš„å€é–“<br>
è€Œå¹³å‡æ¶ˆè²»é‡‘é¡æœ€å¤šåŒæ¨£ç‚º30-49æ­²ï¼Œä½†æ•´é«”å³°åº¦è¼ƒrawå’Œrevä½ï¼Œå€¼å¾—æ³¨æ„çš„æ˜¯å„˜ç®¡méš¨è‘—å¹´é½¡æ¼¸é«˜è€Œä¸‹é™ï¼Œä½†å¹´é½¡æœªçŸ¥æ—ç¾¤å»å¾ˆé«˜<br>
ç¸½åˆ°è¨ªæ¬¡æ•¸ä¸€æ¨£ä»¥30-49æ­²è¼ƒå¤šï¼Œä½†å¹³å‡åˆ°è¨ªæ¬¡æ•¸å‰‡ä»¥æœªçŸ¥æ—ç¾¤é é«˜æ–¼å…¶ä»–å¹´é½¡å€é–“<br>


```{r fig.height=10, fig.width=10}
#å°‡æ•´ç†å¥½çš„è³‡æ–™by area åšè¦–è¦ºåŒ–
melted_data_area = melt(grouped_data_area, id.vars = "area")
j = ggplot(melted_data_area, aes(x = area, y = value, fill = variable)) +
  geom_bar(stat = "identity", position = "dodge", width = 0.5) +
  labs(title = "ä¸åŒåœ°å€çš„åƒæ•¸åˆ†å¸ƒ", y = "å¹³å‡å€¼",x= "åœ°å€") +
  theme_minimal() +
  facet_wrap(~variable, scales = "free_y", ncol = 1)
ggplotly(j)
```


å¯ä»¥çœ‹å‡ºå—æ¸¯å’Œæ±æ­¢ç‚ºæ·¨åˆ©èˆ‡ç²åˆ©è²¢ç»æœ€æ˜é¡¯çš„åœ°å€ï¼Œé é«˜æ–¼å…¶ä»–å€<br>
ä½†å¹³å‡æ¶ˆè²»é‡‘é¡è€Œè¨€çš„è©±å…©è€…æ’åå±…æœ«ï¼Œé¡¯ç¤ºæ­¤å€å¯èƒ½æ˜¯é è‘—é«˜å®¢æˆ¶åŸºæ•¸æˆ–è€…é«˜è³¼è²·é »ç‡æ’èµ·é‡‘æµ<br>
å¹³å‡åˆ°è¨ªæ¬¡æ•¸å‰‡ä»¥æœªçŸ¥åœ°å€æœ€å¤šï¼Œå—æ¸¯æ¬¡ä¹‹ï¼Œæ±æ­¢ç¬¬ä¸‰ï¼Œå…¶é¤˜ç„¡æ˜é¡¯å·®åˆ¥<br>



```{r fig.height=5, fig.width=6}
#é¦¬è³½å…‹åœ–ï¼Œä»¥ä¸‹ç‚ºåˆ†æå¹´é½¡èˆ‡åœ°å€ä¹‹é–“çš„é—œä¿‚
MOSA = function(formula, data) #å®šç¾©ä¸€å€‹å«MOSAçš„å‡½æ•¸ï¼Œä»–æ¥å—å…©å€‹åƒæ•¸
mosaic(formula, data, shade=T,   
  margins=c(0,1,0,0),  #èª¿æ•´åœ–ç‰‡é‚Šè·
  labeling_args = list(rot_labels=c(90,0,0,0)), #æŒ‡å®šlabelçš„é¡¯ç¤ºæ¨¡å¼ï¼Œ90=å‚ç›´é¡¯ç¤º
  gp_labels=gpar(fontsize=9), #labelå­—é«”å¤§å°
  legend_args=list(fontsize=9), #legendå­—é«”å¤§å°
  gp_text=gpar(fontsize=7), #è£¡é¢æ–‡æœ¬çš„å­—é«”å¤§å°(ä¸‹åœ–æ–¹æ¡†ä¸­é¡¯ç¤ºçš„æ•¸å­—)
  labeling=labeling_residuals) #ä½¿ç”¨æ®˜å·®labeling

MOSA(~age+area, A)
```

å—æ¸¯å€çš„æ¶ˆè²»è€…å¤šç‚º45æ­²ä»¥ä¸Šçš„æ—ç¾¤ï¼Œä¸” u69 æœ€é¡¯è‘—ï¼Œä»£è¡¨å—æ¸¯å€çš„é«˜é½¡æ—ç¾¤æ™®éæœƒå‰å¾€è³¼è²·ï¼Œä½†30-39æ­²çš„æ—ç¾¤å‰‡å¦ <br> æ±æ­¢å…§æ¹–çš„æ¶ˆè²»è€…å¤šç‚º30-39æ­²æ—ç¾¤ï¼Œä½†u49ä»¥ä¸Š(45æ­²ä»¥ä¸Š)æ¯”è¼ƒä¸æœƒå‰å¾€è³¼è²·<br>



#### å¹´é½¡å€éš”ç‰¹å¾µ Age Segmentation
```{r}
#ä»¥å¹´é½¡åˆ†ç¾¤ï¼Œé‡å°å¹³å‡è³¼è²·æ¬¡æ•¸ã€å¹³å‡å®¢å–®åƒ¹ä½œåˆ†æï¼Œä¸¦ä¸”ä»¥å¹´é½¡æ—ç¾¤äººæ•¸ä½œç‚ºæ³¡æ³¡å¤§å°
A %>% 
  group_by(age) %>%
    summarize(
      Group.Size = n(),              # æ—ç¾¤äººæ•¸
      avg.Freq = mean(f),            # å¹³å‡è³¼è²·æ¬¡æ•¸
      avg.Revenue = sum(f*m)/sum(f)  # å¹³å‡å®¢å–®åƒ¹
  ) %>% 
    ggplot(aes(y=avg.Freq, x=avg.Revenue)) +
    geom_point(aes(col=age, size=Group.Size), alpha=0.5) +
    geom_text(aes(label=age)) +
    scale_size(range=c(5,25)) +
    theme_bw() + theme(legend.position="none") +
    ggtitle("å¹´é½¡å€éš”ç‰¹å¾µ (æ³¡æ³¡å¤§å°:æ—ç¾¤äººæ•¸)") + 
    ylab("å¹³å‡è³¼è²·æ¬¡æ•¸") + xlab("å¹³å‡å®¢å–®åƒ¹") +
    geom_vline(xintercept = sum(A$f*A$m)/sum(A$f), col="purple", linetype = "dashed")+
    geom_hline(yintercept = mean(A$f), col="darkcyan", linetype="dashed")   
  
```

30-44æ­²çš„äººå¹³å‡å®¢å–®åƒ¹æ˜é¡¯è¼ƒé«˜<br>
å¤§æ–¼65æ­²çš„æ—ç¾¤å¹³å‡å®¢å–®åƒ¹æœ€ä½ï¼Œä½†å¹³å‡è³¼è²·æ¬¡æ•¸è¼ƒé«˜<br>


```{r}
mean(A$age == "none")
```

ç”±æ–¼`None`(æ²’æœ‰å¹´é½¡è³‡æ–™çš„é¡§å®¢)äººæ•¸ä¸å¤šï¼Œè€Œä¸”ç‰¹å¾µå¾ˆç¨ç‰¹ï¼Œæ¢ç´¢æ™‚æˆ‘å€‘å¯ä»¥è€ƒæ…®æ¿¾æ‰é€™ç¾¤é¡§å®¢<br>
```{r}
#æ¿¾æ‰æ²’æœ‰å¹´é½¡è³‡æ–™çš„é¡§å®¢ï¼Œä»¥å¹´é½¡åˆ†ç¾¤ï¼Œé‡å°å¹³å‡è³¼è²·æ¬¡æ•¸ã€å¹³å‡å®¢å–®åƒ¹ä½œåˆ†æï¼Œä¸¦ä¸”ä»¥å¹´é½¡æ—ç¾¤äººæ•¸ä½œç‚ºæ³¡æ³¡å¤§å°
A %>% 
  filter(age!="none") %>%    # æ¿¾æ‰æ²’æœ‰å¹´é½¡è³‡æ–™çš„é¡§å®¢('a99')
  group_by(age) %>% 
    summarize(
      Group.Size = n(),              # æ—ç¾¤äººæ•¸
      avg.Freq = mean(f),            # å¹³å‡è³¼è²·æ¬¡æ•¸
      avg.Revenue = sum(f*m)/sum(f)  # å¹³å‡å®¢å–®åƒ¹
  ) %>% 
      ggplot(aes(y=avg.Freq, x=avg.Revenue)) +
      geom_point(aes(col=age, size=Group.Size), alpha=0.5)+#geom_point=æ·»åŠ æ•£é»åœ–ï¼Œæ ¹æ“šageè¨­ç½®é¡è‰²ã€æ ¹æ“šGroup.Sizeè¨­å®šå¤§å°
      geom_text(aes(label=age)) +
      scale_size(range=c(5,25)) +#è¨­ç½®é»çš„å¤§å°Range from 5 to 25
      theme_bw() + theme(legend.position="none") +#è¨­ç½®ä¸»é¡Œç‚ºå…¨ç™½ï¼Œä¸¦ä¸”ä¸é¡¯ç¤ºåœ–ä¾‹
      ggtitle("å¹´é½¡å€éš”ç‰¹å¾µ (æ³¡æ³¡å¤§å°:æ—ç¾¤äººæ•¸)") + 
      ylab("å¹³å‡è³¼è²·æ¬¡æ•¸") + xlab("å¹³å‡å®¢å–®åƒ¹")  +  
      geom_vline(xintercept = sum(A$f*A$m)/sum(A$f), col="purple", linetype = "dashed")+
      geom_hline(yintercept = mean(A$f), col="darkcyan", linetype="dashed")   
```

```{r} 
#æ¿¾æ‰æ²’æœ‰å¹´é½¡è³‡æ–™çš„é¡§å®¢ï¼Œä»¥å¹´é½¡åˆ†ç¾¤ï¼Œé‡å°å¹³å‡è³¼è²·å–®åƒ¹ã€å¹³å‡è³¼è²·ç¸½é‡‘é¡ä½œåˆ†æï¼Œä¸¦ä¸”ä»¥å¹´é½¡æ—ç¾¤äººæ•¸ä½œç‚ºæ³¡æ³¡å¤§å°
A%>%
  filter(age!="none")  %>%  #æ¿¾æ‰æ²’æœ‰å¹´é½¡è³‡æ–™å’Œåœ°å€æœªçŸ¥çš„é¡§å®¢
  group_by(age) %>% 
  summarize(
  Group.Size = n(),              # æ—ç¾¤å¤§å°
  avg.total = mean(rev),          # å¹³å‡è³¼è²·ç¸½é‡‘é¡
  avg.price = sum(f*m)/sum(m)  # å¹³å‡å®¢å–®åƒ¹
  ) %>% 
  ggplot(aes(y=avg.price, x=avg.total)) +
  geom_point(aes(col=age, size=Group.Size), alpha=0.5) +
  geom_text(aes(label=age)) +
  scale_size(range=c(5,25)) +
  theme_bw() + theme(legend.position="none") +
  ggtitle("å¹´é½¡å€éš”ç‰¹å¾µ (æ³¡æ³¡å¤§å°:æ—ç¾¤äººæ•¸)") + 
  geom_vline(xintercept = mean(A$rev),col="purple",linetype = "dashed")+
  geom_hline(yintercept = sum(A$f*A$m)/sum(A$m), col="darkcyan", linetype="dashed")+
  ylab("å¹³å‡å–®åƒ¹") + xlab("å¹³å‡è³¼è²·ç¸½é‡‘é¡")
```



#### åœ°ç†å€éš”ç‰¹å¾µ Area Segmentation
```{r}
#æ¿¾æ‰æ²’æœ‰å¹´é½¡è³‡æ–™å’ŒæœªçŸ¥åœ°å€çš„é¡§å®¢ï¼Œä»¥åœ°å€åˆ†ç¾¤ï¼Œé‡å°å¹³å‡è³¼è²·æ¬¡æ•¸ã€å¹³å‡å®¢å–®åƒ¹ä½œåˆ†æï¼Œä¸¦ä¸”ä»¥åœ°å€æ—ç¾¤äººæ•¸ä½œç‚ºæ³¡æ³¡å¤§å°
A %>% 
  filter(age!="none"& area!="zUnknown") %>%    # æ¿¾æ‰æ²’æœ‰å¹´é½¡è³‡æ–™çš„é¡§å®¢
  group_by(area) %>% 
    summarize(
      Group.Size = n(),              # æ—ç¾¤äººæ•¸
      avg.Freq = mean(f),            # å¹³å‡è³¼è²·æ¬¡æ•¸
      avg.Revenue = sum(f*m)/sum(f)  # å¹³å‡å®¢å–®åƒ¹
  ) %>% 
    ggplot(aes(y=avg.Freq, x=avg.Revenue)) + 
    geom_point(aes(col=area, size=Group.Size), alpha=0.5) + #geom_point=æ·»åŠ æ•£é»åœ–ï¼Œæ ¹æ“šareaè¨­ç½®é¡è‰²ã€æ ¹æ“šGroup.Sizeè¨­å®šå¤§å°
    geom_text(aes(label=area)) + 
    scale_size(range=c(5,25)) + #è¨­ç½®é»çš„å¤§å°Range from 5 to 25
    theme_bw() + theme(legend.position="none") + #è¨­ç½®ä¸»é¡Œç‚ºå…¨ç™½ï¼Œä¸¦ä¸”ä¸é¡¯ç¤ºåœ–ä¾‹
    ggtitle("åœ°ç†å€éš”ç‰¹å¾µ (æ³¡æ³¡å¤§å°:æ—ç¾¤äººæ•¸)") + 
    ylab("å¹³å‡è³¼è²·æ¬¡æ•¸") + xlab("å¹³å‡å®¢å–®åƒ¹")+  
    geom_vline(xintercept = sum(A$f*A$m)/sum(A$f), col="purple", linetype = "dashed")+
    geom_hline(yintercept = mean(A$f), col="darkcyan", linetype= "dashed")  
```

å—æ¸¯å€çš„äººå¹³å‡è³¼è²·æ¬¡æ•¸é«˜ï¼Œä½†æ˜¯å¹³å‡å®¢å–®åƒ¹æœ€ä½ã€‚å¤§å®‰å€åä¹‹<br>


```{r}
#æ¿¾æ‰æ²’æœ‰å¹´é½¡è³‡æ–™å’ŒæœªçŸ¥åœ°å€çš„é¡§å®¢ï¼Œä»¥åœ°å€åˆ†ç¾¤ï¼Œé‡å°æœ€è¿‘ä¸€æ¬¡è³¼è²·æ—¥æ•¸ã€å¹³å‡å®¢å–®åƒ¹ä½œåˆ†æï¼Œä¸¦ä¸”ä»¥åœ°å€æ—ç¾¤äººæ•¸ä½œç‚ºæ³¡æ³¡å¤§å°
A %>% filter(age!="None"& area!="zUnknown") %>%    # æ¿¾æ‰æ²’æœ‰å¹´é½¡è³‡æ–™å’Œåœ°å€æœªçŸ¥çš„é¡§å®¢
  group_by(area) %>% summarize(
  Group.Size = n(),              # æ—ç¾¤äººæ•¸
  avg.lastday = mean(r),           # å¹³å‡æœ€è¿‘ä¸€æ¬¡è³¼è²·æ—¥
  avg.Revenue = sum(f*m)/sum(f)  # å¹³å‡å®¢å–®åƒ¹
  ) %>% 
  ggplot(aes(y=avg.lastday, x=avg.Revenue)) +
  geom_point(aes(col=area, size=Group.Size), alpha=0.5) +
  geom_text(aes(label=area)) +
  scale_size(range=c(5,25)) +
  theme_bw() + theme(legend.position="none") +
  ggtitle("åœ°ç†å€éš”ç‰¹å¾µ (æ³¡æ³¡å¤§å°:æ—ç¾¤äººæ•¸)") + 
  geom_vline(xintercept = sum(A$f*A$m)/sum(A$f),col="purple",linetype = "dashed")+
  geom_hline(yintercept = mean(A$r), col="darkcyan", linetype="dashed")+
  ylab("å¹³å‡æœ€è¿‘ä¸€æ¬¡è³¼è²·æ—¥") + xlab("å¹³å‡å®¢å–®åƒ¹")

```

```{r}
#æ¿¾æ‰æ²’æœ‰å¹´é½¡è³‡æ–™å’ŒæœªçŸ¥åœ°å€çš„é¡§å®¢ï¼Œä»¥åœ°å€åˆ†ç¾¤ï¼Œé‡å°å¹³å‡è³¼è²·æ¬¡æ•¸ç‡ã€å¹³å‡ç¸½é‡‘é¡ä½œåˆ†æï¼Œä¸¦ä¸”ä»¥åœ°å€æ—ç¾¤äººæ•¸ä½œç‚ºæ³¡æ³¡å¤§å°

A %>% filter(age!="None"&area!="zUnknown") %>%    # æ¿¾æ‰æ²’æœ‰å¹´é½¡è³‡æ–™å’Œåœ°å€æœªçŸ¥çš„é¡§å®¢
  group_by(area) %>% summarize(
  Group.Size = n(),              # æ—ç¾¤äººæ•¸
  avg.freq = mean(f),           # å¹³å‡è³¼è²·é »ç‡
  avg.total = mean(rev)  # å¹³å‡ç¸½é‡‘é¡
  ) %>% 
  ggplot(aes(y=avg.freq, x=avg.total)) +
  geom_point(aes(col=area, size=Group.Size), alpha=0.5) +
  geom_text(aes(label=area)) +
  scale_size(range=c(5,25)) +
  theme_bw() + theme(legend.position="none") +
  ggtitle("åœ°ç†å€éš”ç‰¹å¾µ (æ³¡æ³¡å¤§å°:æ—ç¾¤äººæ•¸)") + 
  geom_vline(xintercept = mean(A$rev),col="purple",linetype = "dashed")+
  geom_hline(yintercept = mean(A$f), col="darkcyan", linetype="dashed")+
  ylab("å¹³å‡è³¼è²·æ¬¡æ•¸") + xlab("å¹³å‡ç¸½é‡‘é¡")

```


```{r}
#æ¿¾æ‰æ²’æœ‰å¹´é½¡è³‡æ–™å’ŒæœªçŸ¥åœ°å€çš„é¡§å®¢ï¼Œä»¥åœ°å€åˆ†ç¾¤ï¼Œé‡å°å¹³å‡è³¼è²·æ¬¡æ•¸ã€å¹³å‡å®¢å–®åƒ¹ä½œåˆ†æï¼Œä¸¦ä¸”ä»¥åœ°å€æ—ç¾¤äººæ•¸ä½œç‚ºæ³¡æ³¡å¤§å°
A %>% filter(age!="None"&area!="zUnknown") %>%    # æ¿¾æ‰æ²’æœ‰å¹´é½¡è³‡æ–™å’Œåœ°å€æœªçŸ¥çš„é¡§å®¢
  group_by(area) %>% summarize(
  Group.Size = n(),              # æ—ç¾¤äººæ•¸
  avg.Freq = mean(f),            # å¹³å‡è³¼è²·æ¬¡æ•¸
  avg.Revenue = sum(f*m)/sum(f)  # å¹³å‡å®¢å–®åƒ¹
  ) %>% 
  ggplot(aes(y=avg.Freq, x=avg.Revenue)) +
  geom_point(aes(col=area, size=Group.Size), alpha=0.5) +
  geom_text(aes(label=area)) +
  scale_size(range=c(5,25)) +
  theme_bw() + theme(legend.position="none") +
  ggtitle("åœ°ç†å€éš”ç‰¹å¾µ (æ³¡æ³¡å¤§å°:æ—ç¾¤äººæ•¸)") + 
  geom_vline(xintercept = sum(A$f*A$m)/sum(A$f),col="purple",linetype = "dashed")+
  geom_hline(yintercept = mean(A$f), col="darkcyan", linetype="dashed")+
  ylab("å¹³å‡è³¼è²·æ¬¡æ•¸") + xlab("å¹³å‡å®¢å–®åƒ¹")

```


#### é€±å…§äº¤æ˜“é‡åˆ†æ Transactions in Week Days

```{r fig.height=2, fig.width=6}
#é€±ä¸€åˆ°å‘¨æ—¥äº¤æ˜“é‡åˆ†å¸ƒ 
X$wday = format(X$date, "%u")
par(cex=0.7, mar=c(2,3,2,1))
table(X$wday) %>% 
    barplot(main="No. Transactions in Week Days")
```

```{r fig.height=5, fig.width=6}
#ä»¥å¹´é½¡åˆ†ç¾¤ï¼Œå°‡é€±ä¸€åˆ°å‘¨æ—¥äº¤æ˜“é‡åˆ†å¸ƒè¦–è¦ºåŒ–è¼¸å‡º
X %>% 
  mutate(wd=factor(format(date, "%w"))) %>% 
    count(age, wd) %>% 
    ggplot(aes(x=wd, y=n,fill=age)) +
    geom_bar(stat="Identity") +
    labs(title="Each Age Group F By Weekday", y="Total")+
    facet_wrap(~age) #æ ¹æ“šageå°‡åœ–è¡¨åˆ†æˆå¤šå€‹å­åœ–
#ä¸‹åœ–æ©«è»¸é †åºçš†ç‚ºæ—¥ä¸€äºŒä¸‰...å…­
```
 
é™¤äº†å¹´ç´€è¼ƒå¤§å’Œæœ€å°çš„æ—ç¾¤ä»¥å¤–ï¼Œå…¶ä»–å‚¾å‘æ–¼å‡æ—¥(å¯èƒ½å› ç‚ºè¦ä¸Šç­)<br>

```{r fig.height=5, fig.width=6}
#ä»¥åœ°å€åˆ†ç¾¤ï¼Œå°‡é€±ä¸€åˆ°å‘¨æ—¥äº¤æ˜“é‡åˆ†å¸ƒè¦–è¦ºåŒ–è¼¸å‡º
X %>% 
  mutate(wd=factor(format(date, "%w"))) %>% 
    count(area, wd) %>% 
    ggplot(aes(x=wd, y=n,fill=area)) +
    geom_bar(stat="Identity") +
    labs(title="Each Area Group F By Weekday", y="Total")+
    facet_wrap(~area) #æ ¹æ“šareaå°‡åœ–è¡¨åˆ†æˆå¤šå€‹å­åœ–
#ä¸‹åœ–æ©«è»¸é †åºçš†ç‚ºæ—¥ä¸€äºŒä¸‰...å…­
```

å—æ¸¯æ±æ­¢æ•¸é‡æ˜é¡¯é«˜å¤ªå¤šäº†ï¼ŒåŸºæœ¬ä¸Šå¯ä»¥ç¢ºå®šé€™å®¶åº—å°±åœ¨å—æ¸¯é è¿‘æ±æ­¢çš„åœ°æ–¹ã€‚<br>
è‡³æ–¼é€±å…§åˆ†å¸ƒæ•´é«”è€Œè¨€ä¹Ÿä»¥å…­æ—¥å±…å¤š<br>


#### å•†å“ç¨®é¡åˆ†ç¾¤åˆ†æ Product Analysis

```{r}
#æ ¹æ“šå•†å“ç¨®é¡åˆ†ç¾¤ä¸¦è¨ˆç®—Total qunatity, total revenue, total profit, etc.
dfbycat = df %>% group_by(cat) %>% summarize(
  noProd = n_distinct(prod),
  Tqty = sum(qty),
  Trev = sum(price),
  Traw = sum(price) - sum(cost),
  GPM = Traw/Trev,  #Gross Profit Margin
  Weightedprice = round(Trev/Tqty,2)
  )
str(dfbycat)
head(dfbycat)
```


```{r}
#ç™¾å¤§å•†å“ç‡Ÿæ”¶èˆ‡æ¯›åˆ©ä¹‹è²¢ç»è¦–è¦ºåŒ–
Trev100 = arrange(dfbycat, desc(Trev)) %>%  #æ ¹æ“šTrevæ’åº
  mutate(Trev_ind=Trev/sum(Trev) *100, Trev_cum=cumsum(Trev_ind)) %>%  #
  head(100) %>% 
    ggplot(aes(x=1:100)) +
    geom_col(aes(y=Trev_cum),fill="magenta",alpha=0.5) +
    geom_col(aes(y=Trev_ind), fill="cyan",alpha=0.5) +
    labs(title="ç™¾å¤§å•†å“è²¢ç»ç‡Ÿæ”¶", x="ç¬¬nå¤§å•†å“", y="è²¢ç»ç‡Ÿæ”¶ç´¯è¨ˆç™¾åˆ†æ¯”") +
    theme_bw()

Traw100 = arrange(dfbycat, desc(Traw)) %>%  #æ ¹æ“šTrawæ’åº
  mutate(Traw_ind=Traw/sum(Traw) *100, Traw_cum=cumsum(Traw_ind)) %>%  #
  head(100) %>% 
    ggplot(aes(x=1:100)) +
    geom_col(aes(y=Traw_cum),fill="violet",alpha=0.5) +
    geom_col(aes(y=Traw_ind), fill="blue",alpha=0.5) +
    labs(title="ç™¾å¤§å•†å“æ¯›åˆ©ç‡Ÿæ”¶", x="ç¬¬nå¤§å•†å“", y="è²¢ç»æ¯›åˆ©ç´¯è¨ˆç™¾åˆ†æ¯”") +
    theme_bw()

subplot(Trev100, Traw100, nrows = 1) %>% layout(title = "ç™¾å¤§å•†å“ç‡Ÿæ”¶èˆ‡æ¯›åˆ©ç´¯ç©ç™¾åˆ†æ¯”")

```


å¯ä»¥çœ‹è¦‹2007å€‹å•†å“ä¸­ï¼Œå‰ç™¾å¤§å•†å“ä½”äº†å°‡è¿‘ä¸€åŠçš„ç‡Ÿæ”¶è²¢ç»<br>
å‰10å¤§å•†å“å°±ä½”äº†ç´„19%çš„ç‡Ÿæ”¶èˆ‡12%çš„æ¯›åˆ©<br>
å‰20å¤§å•†å“ä½”äº†ç´„27%çš„ç‡Ÿæ”¶èˆ‡19%çš„æ¯›åˆ©<br>
å‰50å¤§å•†å“ä½”äº†ç´„42%çš„ç‡Ÿæ”¶èˆ‡31%çš„æ¯›åˆ©<br>
-->é¡¯ç¾ä¸»åŠ›å•†å“ä»¥è–„åˆ©å¤šéŠ·ç‚ºä¸»<br>


```{r}
#å‰20å¤§ç†±é–€çš„å•†å“
top20 = tapply(df$qty,df$cat,sum) %>% sort %>% tail(20) %>% names
top20
```

```{r fig.height=6, fig.width=8}
#å‰20å¤§å“é …èˆ‡å¹´é½¡çš„é—œä¿‚
MOSA(~cat+age, df[df$cat %in% top20,])
```
```{r fig.height=6, fig.width=8}
#å‰20å¤§å“é …èˆ‡åœ°å€çš„é—œä¿‚
MOSA(~cat+area, df[df$cat %in% top20,])
```

```{r fig.height=5, fig.width=6}
# ggplot(df, aes(x = df[df$cat %in% top20,], y = area, color = age)) +
#   geom_point(size = 3) +
#   labs(title = "è¨‚å–®åˆ†å¸ƒä¸‰é»åœ–", x = "å•†å“é¡å‹ (cat)", y = "å®¢æˆ¶åœ°å€ä»£ç¢¼ (area)") +
#   theme_minimal()
```



### 4. RFMçŸ©é™£ è¦å‰‡åˆ†ç¾¤ RFM Model
RFMæ¨¡å‹ï¼š
rï¼ˆrecencyï¼‰æœ€è¿‘ä¸€æ¬¡æ¶ˆè²»ï¼šè‹¥é¡§å®¢ä¸Šæ¬¡æ¶ˆè²»ç´€éŒ„çš„æ™‚é–“æ„ˆè¿‘å‰‡åƒ¹å€¼æ„ˆå¤§ã€‚
fï¼ˆfrequencyï¼‰æ¶ˆè²»é »ç‡ï¼šé¡§å®¢åœ¨æ‰€é¸æœŸé–“ä¸­æœ‰å¹¾æ¬¡æ¶ˆè²»ç´€éŒ„ï¼Ÿé »ç‡æ„ˆé«˜å‰‡åƒ¹å€¼æ„ˆå¤§ã€‚
mï¼ˆmonetaryæ¶ˆè²»é‡‘é¡ï¼‰ï¼šé¡§å®¢çš„ç¸½æ¶ˆè²»é¡ï¼Œå³ç‚ºå…¬å¸è²¢ç»äº†å¤šå°‘åˆ©æ½¤ï¼Ÿé‡‘é¡æ„ˆé«˜å‰‡åƒ¹å€¼æ„ˆå¤§ã€‚

```{r}
#å®šç¾©å‡½æ•¸
hmap1 = function(x, ...) { heatmaply(
  as.data.frame.matrix(x), cexRow=0.7, cexCol=0.7, 
  grid_color='gray70', ...)
  }  
```


```{r}
#åœ¨é¡§å®¢è³‡æ–™æ¡†åŠ å…¥è¦å‰‡åˆ†ç¾¤æ¬„ä½
bm = c(0, quantile(A$m,c(.25,0.5,.75)), max(A$m)+100)
bf = c(0, quantile(A$f,c(.25,0.5,.75)), max(A$f)+100)
A = A %>% mutate(
  mx = cut(A$m, bm, labels=paste0('M',1:4)),
  fx = cut(A$f, bf, labels=paste0('F',1:4)),
  MF = paste0(mx, fx)
  )
table(A$mx, A$fx)
```


```{r}
#æ‰¾å‡ºç‡Ÿæ”¶æœ€å¤§çš„å“é¡
cat100 = count(df, cat, wt=price, sort=T) %>% mutate(
  pc=n/sum(n), cum.pc=cumsum(pc)) %>% head(100)
cat100[c(1:5,96:100), ]
```



```{r}
#åšå‡ºé¡§å®¢æ—ç¾¤xå“é¡ è³¼è²·é‡‘é¡çŸ©é™£ 
df = inner_join(df, A[,c('cust','MF')])
mx0 = xtabs(price~MF+cat, filter(df, cat %in% cat100$cat[1:30]))
dim(mx0)
```


```{r}
#ä¾è³¼è²·é‡‘é¡çŸ©é™£è£½ä½œç†±åœ–
hmap1(mx0, col=cool_warm)
```

#### æ­£è¦åŒ– -è³¼è²·æ¯”ä¾‹çŸ©é™£ 
```{r}
mx1 = mx0/rowSums(mx0)
hmap1(mx1, col=cool_warm)
```


```{r}
#ç†±åœ–çš„åˆ†ç¾¤åŠŸèƒ½
mx2 = xtabs(price~MF+cat, filter(df, cat %in% cat100$cat[1:20]))
mx3 = 100*mx2/rowSums(mx2)
hmap1(mx3, col=cool_warm, show_dendrogram=c(T,F),k_row=5)
```


```{r}
#ä¾æ“šé¡§å®¢æ—ç¾¤èˆ‡å•†å“å“é¡çš„è³¼è²·é‡‘é¡çŸ©é™£
df0 = inner_join(df, A[,c('cust','MF')])
mx0 = xtabs(price~MF+cat, filter(df, cat %in% cat100$cat[1:30]))
dim(mx0)
print(mx0)

hmap1 = function(x, ...) { heatmaply(
  as.data.frame.matrix(x), cexRow=0.7, cexCol=0.7, 
  grid_color='gray70', ...)
  } 
hmap1(mx0, col=cool_warm)

##é¡è‰²è¶Šæ·±ï¼Œè¡¨ç¤ºåƒ¹æ ¼åœ¨å°æ‡‰çš„ç”¢å“èˆ‡ç´šè·ä¸­å æ¯”è¾ƒé«˜ï¼Œé¡è‰²è¶Šæ·ºï¼Œè¡¨ç¤ºåƒ¹æ ¼ä½å æ¯”è¾ƒé«˜(?)
```

```{r}
#ä¾æ“šé¡§å®¢æ—ç¾¤èˆ‡å•†å“å“é¡çš„è³¼è²·é‡‘é¡çŸ©é™£
df = inner_join(df, A[,c('cust','MF')])
A$age_1 = as.character(A$age)
# åˆªé™¤ageçš„'u'
A$age_1 = as.numeric(sub("u", "", A$age_1))
df = inner_join(df, A[, c('cust', 'MF', 'age_1')])

mx1 = xtabs(age_1~MF+cat, filter(df, cat %in% cat100$cat[1:30]))
dim(mx1)
print(mx1)

hmap1(mx1, col=cool_warm)

#é¡è‰²è¶Šæ·±ï¼Œè¡¨ç¤ºå¹´é½¡å¤§çš„å®¢æˆ¶åœ¨å°æ‡‰çš„ç”¢å“èˆ‡ç´šè·ä¸­å æ¯”è¼ƒé«˜ï¼Œé¡è‰²è¶Šæ·ºï¼Œè¡¨ç¤ºå¹´é½¡å°çš„å®¢æˆ¶å æ¯”è¼ƒé«˜(?)
```



### 5. R(S)FMèˆ‡é›†ç¾¤åˆ†æï¼š RSFM Model with Clustering Analysis 
#### Ref:https://rpubs.com/skydome20/R-Note9-Clustering

åœ¨å‚³çµ±çš„RFMæ¨¡å‹åŠ ä¸Šæ–°çš„è®Šæ•¸ï¼Œå†å°‡æ•¸æ“šé€²è¡Œæ¨™æº–åŒ–å¾Œï¼Œåˆ©ç”¨K-Meansé‡å°
r(æœ€è¿‘ä¸€æ¬¡æ¶ˆè²»æ™‚é–“)ã€s(ç¬¬ä¸€æ¬¡è³¼è²·æ—¥æœŸ)ã€f(æ¶ˆè²»é »ç‡)ã€m(æ¶ˆè²»é‡‘é¡)å››é …ç‰¹å¾µåšéšå±¤å¼é›†ç¾¤åˆ†æï¼Œå°‡æ•¸è¬åæ¶ˆè²»è€…ä¾æ“šå››ç¶­ç‰¹æ€§åˆ†ç¾¤ã€‚

```{r}
rsfm = scale(A[,2:5]) %>% data.frame #Standardizing rsfm
head(rsfm)
```

```{r}
#Hierarchical method
rsfmcluster = hclust(dist(rsfm), method='ward.D')# Euclidean method to get distance matrix, Ward Method (ANOVA) to get cluster
plot(rsfmcluster)
```



```{r}
#Make 5 cluster(è£½ä½œåˆ†ç¾¤å‘é‡)
set.seed(11)
rsfm5 = cutree(rsfmcluster, k=5)  
```

```{r}
#r,s,f,m çš„å¹³å‡
rsfmtable = split(rsfm,rsfm5) %>% sapply(colMeans) %>% round(4)  %>% data.frame()
rsfmtable
```


#### å„å®¢ç¾¤çš„r,s,f,mè¦–è¦ºåŒ–

```{r fig.height=6, fig.width=10}
# par(cex=0.8)
#  split(rfm,rfm5) %>%
#    sapply(colMeans) %>% barplot(beside=T,col = c("cyan", "darkcyan", "violet","darkmagenta"))
#    legend('topright',legend=colnames(rfm),fill =c("cyan", "darkcyan", "violet","darkmagenta"))
color_list = c("cyan", "darkcyan", "violet", "darkmagenta")
par(mfrow = c(1, 5)) 
rsfm_means <- split(rsfm, rsfm5) %>% sapply(colMeans)

for (i in 1:5) {
  barplot(rsfm_means[, i], beside = TRUE, col = color_list,
          main = paste("Group", i), names.arg = colnames(rsfm),
          ylim = c(-1.5, 2))  
}

```

æˆ‘å€‘å¯ä»¥å°‡é¡§å®¢åˆ†å‡ºäº”ç¾¤ï¼š

Group1ï¼šä¸€èˆ¬é¡§å®¢ (normal)
rä½ã€sé«˜ã€få±…ä¸­ã€må±…ä¸­ -->æœ€è¿‘è³¼è²·çš„å¤©æ•¸ä½æ–¼å¹³å‡ï¼Œå¯èƒ½è¡¨ç¤ºä»–å€‘æ˜¯æ¯”è¼ƒå¿ èª çš„é¡§å®¢ã€‚åŒæ™‚ï¼Œä»–å€‘çš„è³¼è²·æ­·å²æœ€æ—©çš„å¤©æ•¸é«˜æ–¼å¹³å‡ï¼Œé€™å¯èƒ½æ„å‘³è‘—ä»–å€‘å·²ç¶“æ˜¯é•·æœŸçš„å¿ èª å®¢æˆ¶ã€‚ä»–å€‘çš„è³¼è²·æ¬¡æ•¸å’Œå¹³å‡è³¼è²·é‡‘é¡ç´„ç‚ºå¹³å‡æ°´å¹³ï¼Œå¯èƒ½æ˜¯ç©©å®šä¸”æœ‰ä¸­ç­‰æ¶ˆè²»æ°´å¹³çš„é¡§å®¢ã€‚ <br>

Group2ï¼šæ–°é€²é¡§å®¢ (new)
rä½ã€séå¸¸ä½ã€fä½ã€mç•¥ä½ -->æœ€è¿‘è³¼è²·çš„å¤©æ•¸ä½æ–¼å¹³å‡ï¼Œå¯èƒ½ä¹Ÿæ˜¯ç›¸å°å¿ èª çš„é¡§å®¢ã€‚ç„¶è€Œï¼Œä»–å€‘çš„è³¼è²·æ­·å²æœ€æ—©çš„å¤©æ•¸éå¸¸ä½æ–¼å¹³å‡ï¼Œé€™æ„å‘³è‘—ä»–å€‘å¯èƒ½æ˜¯ç›¸å°æ–°çš„é¡§å®¢ã€‚ä»–å€‘çš„è³¼è²·æ¬¡æ•¸ä½æ–¼å¹³å‡ï¼Œå¹³å‡è³¼è²·é‡‘é¡ç•¥ä½æ–¼å¹³å‡ï¼Œå¯èƒ½æ˜¯å¹³å‡è²¢ç»éŠ·å”®é¡ç›¸å°è¼ƒå°çš„å¿ èª é¡§å®¢ã€‚<br>

Group3ï¼šæ²‰é»˜é¡§å®¢ (silence)
réå¸¸é«˜ã€sç•¥é«˜ã€fä½ã€mç•¥ä½ -->æœ€è¿‘è³¼è²·çš„å¤©æ•¸é é«˜æ–¼å¹³å‡ï¼Œå¯èƒ½æ˜¯ä¸å¤ªæ´»èºçš„é¡§å®¢ã€‚ç„¶è€Œï¼Œä»–å€‘çš„è³¼è²·æ­·å²æœ€æ—©çš„å¤©æ•¸ç•¥é«˜æ–¼å¹³å‡ï¼Œé€™å¯èƒ½è¡¨ç¤ºä»–å€‘åœ¨è¼ƒæ—©çš„æ™‚é–“é»æ›¾ç¶“æ˜¯æ´»èºçš„é¡§å®¢ã€‚ä»–å€‘çš„è³¼è²·æ¬¡æ•¸ä½æ–¼å¹³å‡ï¼Œå¹³å‡è³¼è²·é‡‘é¡ä¹Ÿç•¥ä½æ–¼å¹³å‡ï¼Œå¯èƒ½æ˜¯ä¸å¤ªæ´»èºä¸”æœ‰ä¸­ç­‰æ¶ˆè²»æ°´å¹³çš„é¡§å®¢ã€‚<br>

Group4ï¼šé«˜è³¼è²·åŠ›é¡§å®¢ (highp) --> #é‡è¦ç™¼å±•å®¢æˆ¶
rç•¥é«˜ã€sä½ã€fä½ã€méå¸¸é«˜ -->é¡§å®¢æœ€è¿‘è³¼è²·çš„å¤©æ•¸ç•¥é«˜æ–¼å¹³å‡ï¼Œä½†ä»–å€‘çš„è³¼è²·æ­·å²æœ€æ—©çš„å¤©æ•¸ä½æ–¼å¹³å‡ï¼Œé€™å¯èƒ½è¡¨ç¤ºä»–å€‘åœ¨è¼ƒæ—©çš„æ™‚é–“é»æ›¾ç¶“æ˜¯æ´»èºçš„é¡§å®¢ï¼Œä½†ç¾åœ¨è®Šå¾—ä¸å¤ªæ´»èºã€‚ä»–å€‘çš„è³¼è²·æ¬¡æ•¸ä½æ–¼å¹³å‡ï¼Œä½†å¹³å‡è³¼è²·é‡‘é¡éå¸¸é«˜æ–¼å¹³å‡ï¼Œé€™å¯èƒ½æ˜¯é«˜åƒ¹å€¼ä½†ä¸å¤ªæ´»èºçš„é¡§å®¢ã€‚<br>

Group5ï¼šé•·æœŸå¿ èª é¡§å®¢ (longterm) -->#ä¸€èˆ¬ä¿æŒå®¢æˆ¶
rä½ã€ã€sé«˜ã€féå¸¸é«˜ã€mä½ -->é¡§å®¢æœ€è¿‘è³¼è²·çš„å¤©æ•¸ä½æ–¼å¹³å‡ï¼Œå¯èƒ½æ˜¯æ¯”è¼ƒå¿ èª çš„é¡§å®¢ã€‚ä»–å€‘çš„è³¼è²·æ­·å²æœ€æ—©çš„å¤©æ•¸é«˜æ–¼å¹³å‡ï¼Œé€™å¯èƒ½æ„å‘³è‘—ä»–å€‘å·²ç¶“æ˜¯é•·æœŸçš„å¿ èª å®¢æˆ¶ã€‚ç„¶è€Œï¼Œä»–å€‘çš„è³¼è²·æ¬¡æ•¸é é é«˜æ–¼å¹³å‡ï¼Œä½†å¹³å‡è³¼è²·é‡‘é¡ä½æ–¼å¹³å‡ï¼Œé€™å¯èƒ½æ˜¯é »ç¹è³¼è²·ä½†è³¼è²·é‡‘é¡ä¸é«˜çš„é¡§å®¢ã€‚<br>


```{r}
#Non-hierarchical method: K-means
set.seed(11) #ç¢ºä¿çµæœå¯å¾©ç¾
A$rsfm_group = kmeans(rsfm, centers= 5)$cluster #å¹«æ¯å€‹å®¢äººè²¼r,s,f,mçš„æ¨™ç±¤!
head(A)
```

```{r}
# # of clients in å„å®¢ç¾¤
table(A$rsfm_group)
```


```{r}
#å°‡è³‡æ–™åˆ†é€²å„è‡ªå®¢ç¾¤
normal = split(A,A$rsfm_group)[[1]]
new = split(A,A$rsfm_group)[[2]]
silence = split(A,A$rsfm_group)[[3]]
highp = split(A,A$rsfm_group)[[4]]
longterm = split(A,A$rsfm_group)[[5]]
```



### 6.è£½ä½œé æ¸¬è®Šæ•¸  Preparing The Predictors (X)  
#### Importing Data
```{r echo=T, message=F, cache=F, warning=F}
load("data/tf0.rdata")
```

#### Preprocessing
Remove the data in the last period (After Feb 01).
```{r}
feb01 = as.Date("2001-02-01")   # è³‡æ–™åˆ†å‰²æ—¥æœŸ 
Zs = subset(Z0, date < feb01)    # 618212 é …ç›®
```

#### Aggregate for the Transaction Records
é‡æ–°åŒ¯æ•´äº¤æ˜“ç´€éŒ„ï¼Œå¦‚å‰è¿°çš„å…§å®¹
```{r}
Xs = group_by(Zs, tid) %>% summarise(
  date = first(date),  # date of transaction
  cust = first(cust),  # customer id
  age = first(age),    # age group
  area = first(area),  # area group
  items = n(),                # number of items
  pieces = sum(qty),          # number of pieces
  total = sum(price),         # total amount
  gross = sum(price - cost)   # raw profit
  ) %>% data.frame  # 88387 äº¤æ˜“ç­†æ•¸
```

```{r}
summary(Xs)
```

#### Check Quantile and Remove Outlier 
ç§»é™¤é›¢ç¾¤å€¼
```{r}
sapply(Xs[,6:9], quantile, prob=c(.999, .9995, .9999))
```
```{r}
Xs = subset(Xs, items<=64 & pieces<=98 & total<=11260) # 88387 -> 88295
```

#### Aggregate for Customer Records
é‡æ–°åŒ¯æ•´é¡§å®¢è³‡æ–™
```{r}
d0 = max(Xs$date) + 1
As = Xs %>% mutate(
  days = as.integer(difftime(d0, date, units="days"))
  ) %>% 
  group_by(cust) %>% summarise(
    r = min(days),      # recency
    s = max(days),      # seniority
    f = n(),            # frequency
    m = mean(total),    # monetary
    rev = sum(total),   # total revenue contribution
    raw = sum(gross),   # total gross profit contribution
    age = age[1],       # age group
    area = area[1],     # area code
  ) %>% data.frame      # 28584 é¡§å®¢
nrow(As)
```
<br><br><hr>


### 7. è£½ä½œé æ¸¬è®Šæ•¸ Preparing the Target Variables (Y) 

##### Aggregate Feb's Transaction by Customer
å½™æ•´æœ€å¾Œä¸€æœŸ(äºŒæœˆå¾Œ)è³‡æ–™
```{r}
feb = filter(X, date>= feb01) %>% group_by(cust) %>% 
  summarise(amount = sum(total)) 
summary(feb)
```
`feb$amount`ä¹‹ä¸­æœ‰æœ€å¾Œä¸€æœŸä¾†è²·éçš„`16,900`ä½é¡§å®¢çš„ç‡Ÿæ”¶è²¢ç»

##### The Target for Regression - `A$amount`
å°‡`feb$amount`åŒ¯å…¥`A`
```{r}
As = merge(As, feb, by="cust", all.x=T) #Aå’Œfebå…©å€‹dataframeæœƒæ ¹æ“šcuståˆä½µ (é€™æ˜¯Left Join)
```

##### The Target for Classification - `A$buy`
`A$amount`æ˜¯`NA`ä»£è¡¨é€™ä½é¡§å®¢æœ€å¾Œä¸€æœŸæ²’ä¾†è²· <br>
`A$amount`ä¸æ˜¯`NA`ä»£è¡¨é€™ä½é¡§å®¢æœ€å¾Œä¸€æœŸæœ‰ä¾†è²·é
```{r}
As$buy = !is.na(As$amount)  
table(As$buy, !is.na(As$amount))
```

##### Summary of the Dataset
```{r}
summary(As)
```

```{r}
normal_df = As[As$cust %in% normal$cust,]
new_df = As[As$cust %in% new$cust,]
silence_df = As[As$cust %in% silence$cust,]
highp_df = As[As$cust %in% highp$cust,]
longterm_df = As[As$cust %in% longterm$cust,]
```


è®“`X`èˆ‡`Z`ä¹‹ä¸­çš„è³‡æ–™ç¯„åœèˆ‡`A`ä¸€æ¨£
```{r}
Xs = subset(Xs, cust %in% As$cust & date < as.Date("2001-02-01"))
Zs = subset(Zs, cust %in% As$cust & date < as.Date("2001-02-01"))
```


### 8. è³¼è²·æ©Ÿç‡æ¨¡å‹ Buying Probabilities Model

#### Normal
```{r}
set.seed(11)
normal_spl = sample.split(normal_df$buy, SplitRatio=0.7)
c(nrow(normal_df), sum(normal_spl), sum(!normal_spl))
```

```{r}
cbind(normal_df, normal_spl) %>% filter(buy) %>% 
  ggplot(aes(x=log(amount))) + geom_density(aes(fill=normal_spl), alpha=0.5)
```
```{r}
normal_A0 = subset(normal_df, buy) %>% mutate_at(c("m","rev","amount"), log10)
n = nrow(normal_A0)
set.seed(11)
normal_spl0 = 1:n %in% sample(1:n, round(0.7*n))
c(nrow(normal_A0), sum(normal_spl0), sum(!normal_spl0))
```


```{r}
normal_train = subset(normal_df, normal_spl)
normal_test = subset(normal_df, !normal_spl)
```

```{r}
glm_normal = glm(buy ~ . ,normal_train[,-c(1,10)],family = binomial() )
summary(glm_normal)
```

```{r}
normal_pred = predict(glm_normal, normal_test, type = "response")
normal_confmt = table(actual = normal_test$buy, predict = normal_pred > 0.5)
normal_confmt
```

```{r}
normal_acc.ts = normal_confmt %>% {sum(diag(.))/sum(.)}
c(1-mean(normal_test$buy) , normal_acc.ts) 
```

```{r}
# colAUC(normal_pred, normal_test$buy)
```


#### New
```{r}
set.seed(11)
new_spl = sample.split(new_df$buy, SplitRatio=0.7)
c(nrow(new_df), sum(new_spl), sum(!new_spl))
```

```{r}
cbind(new_df, new_spl) %>% filter(buy) %>% 
  ggplot(aes(x=log(amount))) + geom_density(aes(fill=new_spl), alpha=0.5)
```

```{r}
new_A0 = subset(new_df, buy) %>% mutate_at(c("m","rev","amount"), log10)
n = nrow(new_A0)
set.seed(11)
new_spl0 = 1:n %in% sample(1:n, round(0.7*n))
c(nrow(new_A0), sum(new_spl0), sum(!new_spl0))
```

```{r}
new_train = subset(new_df, new_spl)
new_test = subset(new_df, !new_spl)
```

```{r}
glm_new = glm(buy ~ . ,new_train[,-c(1,10)],family = binomial() )
summary(glm_new)
```

```{r}
new_pred = predict(glm_new, new_test, type = "response")
new_confmt = table(actual = new_test$buy, predict =new_pred > 0.5)
new_confmt
```

```{r}
new_acc.ts = new_confmt %>% {sum(diag(.))/sum(.)}
c(1-mean(new_test$buy) , new_acc.ts) #accuracy approximately 0.73
```

```{r}
colAUC(new_pred, new_test$buy) 
```


#### Silence
```{r}
set.seed(11)
silence_spl = sample.split(silence_df$buy, SplitRatio=0.7)
c(nrow(silence_df), sum(silence_spl), sum(!silence_spl))
```

```{r}
cbind(silence_df, silence_spl) %>% filter(buy) %>% 
  ggplot(aes(x=log(amount))) + geom_density(aes(fill=silence_spl), alpha=0.5)
```
```{r}
silence_A0 = subset(silence_df, buy) %>% mutate_at(c("m","rev","amount"), log10)
n = nrow(silence_A0)
set.seed(11)
silence_spl0 = 1:n %in% sample(1:n, round(0.7*n))
c(nrow(silence_A0), sum(silence_spl0), sum(!silence_spl0))
```


```{r}
silence_train = subset(silence_df, silence_spl)
silence_test = subset(silence_df, !silence_spl)
```

```{r}
glm_silence = glm(buy ~ . ,silence_train[,-c(1,10)],family = binomial() )
summary(glm_silence)
```

```{r}
silence_pred = predict(glm_silence, silence_test, type = "response")
silence_confmt = table(actual = silence_test$buy, predict = silence_pred > 0.5)
silence_confmt
```

```{r}
silence_acc.ts = silence_confmt %>% {sum(diag(.))/sum(.)}
c(1-mean(silence_test$buy) , silence_acc.ts) 
```

```{r}
colAUC(silence_pred, silence_test$buy) 
```

#### Highp
```{r}
set.seed(11)
highp_spl = sample.split(highp_df$buy, SplitRatio=0.7)
c(nrow(highp_df), sum(highp_spl), sum(!highp_spl))
```

```{r}
cbind(highp_df, highp_spl) %>% filter(buy) %>% 
  ggplot(aes(x=log(amount))) + geom_density(aes(fill=highp_spl), alpha=0.5)
```
```{r}
highp_A0 = subset(highp_df, buy) %>% mutate_at(c("m","rev","amount"), log10)
n = nrow(highp_A0)
set.seed(11)
highp_spl0 = 1:n %in% sample(1:n, round(0.7*n))
c(nrow(highp_A0), sum(highp_spl0), sum(!highp_spl0))
```


```{r}
highp_train = subset(highp_df, highp_spl)
highp_test = subset(highp_df, !highp_spl)
```

```{r}
glm_highp = glm(buy ~ . ,highp_train[,-c(1,10)],family = binomial() )
summary(glm_highp)
```

```{r}
highp_pred = predict(glm_highp, highp_test, type = "response")
highp_confmt = table(actual = highp_test$buy, predict = highp_pred > 0.5)
highp_confmt
```

```{r}
highp_acc.ts = highp_confmt %>% {sum(diag(.))/sum(.)}
c(1-mean(highp_test$buy) , highp_acc.ts) 
```

```{r}
colAUC(highp_pred, highp_test$buy) 
```

#### Longterm
```{r}
set.seed(11)
longterm_spl = sample.split(longterm_df$buy, SplitRatio=0.7)
c(nrow(longterm_df), sum(longterm_spl), sum(!longterm_spl))
```

```{r}
cbind(longterm_df, longterm_spl) %>% filter(buy) %>% 
  ggplot(aes(x=log(amount))) + geom_density(aes(fill=longterm_spl), alpha=0.5)
```
```{r}
longterm_A0 = subset(longterm_df, buy) %>% mutate_at(c("m","rev","amount"), log10)
n = nrow(longterm_A0)
set.seed(11)
longterm_spl0 = 1:n %in% sample(1:n, round(0.7*n))
c(nrow(longterm_A0), sum(longterm_spl0), sum(!longterm_spl0))
```

```{r}
longterm_train = subset(longterm_df, longterm_spl)
longterm_test = subset(longterm_df, !longterm_spl)
```

```{r}
glm_longterm = glm(buy ~ . ,longterm_train[,-c(1,10)],family = binomial() )
summary(glm_longterm)
```

```{r}
longterm_pred = predict(glm_longterm, longterm_test, type = "response")
longterm_confmt = table(actual = longterm_test$buy, predict = longterm_pred > 0.5)
longterm_confmt
```

```{r}
longterm_acc.ts = longterm_confmt %>% {sum(diag(.))/sum(.)}
c(1-mean(longterm_test$buy) , longterm_acc.ts) 
```

```{r}
colAUC(longterm_pred, longterm_test$buy) 
```


### 9. è³¼è²·é‡‘é¡æ¨¡å‹ Buying Amount Model

#### Normal
```{r}
# normal_train1 = subset(normal_A0, normal_spl0)
# normal_test1 = subset(normal_A0, !normal_spl0)
```
```{r}
# normal_lm = lm(amount ~ ., normal_train1[,2:10])
# summary(normal_lm)
```

```{r}
# r2.tr_normal = summary(normal_lm)$r.sq
# SST_normal = sum((normal_test1$amount - mean(normail_train1$amount))^ 2)
# SSE_normal = sum((predict(normal_lm, normal_test1) -  normal_test1$amount)^2)
# r2.ts_normal = 1 - (SSE_normal/SST_normal)
# c(R0train_normal=r2.tr_normal, R0test_normal=r2.ts_normal)
```

#### New

```{r}
new_train1 = subset(new_A0, new_spl0)
new_test1 = subset(new_A0, !new_spl0)
```
```{r}
new_lm = lm(amount ~ ., new_train1[,2:10])
summary(new_lm)
```

```{r}
r2.tr_new = summary(new_lm)$r.sq
SST_new = sum((new_test1$amount - mean(new_train1$amount))^ 2)
SSE_new = sum((predict(new_lm, new_test1) -  new_test1$amount)^2)
r2.ts_new = 1 - (SSE_new/SST_new)
c(R0train_new=r2.tr_new, R0test_new=r2.ts_new)
```

#### Silence
```{r}
silence_train1 = subset(silence_A0, silence_spl0)
silence_test1 = subset(silence_A0, !silence_spl0)
```
```{r}
silence_lm = lm(amount ~ ., silence_train1[,2:10])
summary(silence_lm)
```

```{r}
r2.tr_silence = summary(silence_lm)$r.sq
SST_silence = sum((silence_test1$amount - mean(silence_train1$amount))^ 2)
SSE_silence = sum((predict(silence_lm, silence_test1) -  silence_test1$amount)^2)
r2.ts_silence = 1 - (SSE_silence/SST_silence)
c(R0train_silence=r2.tr_silence, R0test_silence=r2.ts_silence)
```

#### Highp
```{r}
highp_train1 = subset(highp_A0, highp_spl0)
highp_test1 = subset(highp_A0, !highp_spl0)
```
```{r}
highp_lm = lm(amount ~ ., highp_train1[,2:10])
summary(highp_lm)
```

```{r}
r2.tr_highp = summary(highp_lm)$r.sq
SST_highp = sum((highp_test1$amount - mean(highp_train1$amount))^ 2)
SSE_highp = sum((predict(highp_lm, highp_test1) - highp_test1$amount)^2)
r2.ts_highp = 1 - (SSE_highp/SST_highp)
c(R0train_highp=r2.tr_highp, R0test_highp=r2.ts_highp)
```

#### Longterm
```{r}
longterm_train1 = subset(longterm_A0, longterm_spl0)
longterm_test1 = subset(longterm_A0, !longterm_spl0)
```
```{r}
longterm_lm = lm(amount ~ ., longterm_train1[,2:10])
summary(longterm_lm)
```

```{r}
r2.tr_longterm = summary(longterm_lm)$r.sq
SST_longterm = sum((longterm_test1$amount - mean(longterm_train1$amount))^ 2)
SSE_longterm = sum((predict(longterm_lm, longterm_test1) - longterm_test1$amount)^2)
r2.ts_longterm = 1 - (SSE_longterm/SST_longterm)
c(R0train_longterm=r2.tr_longterm, R0test_longterm=r2.ts_longterm)
```


### 10. æ›´å¤šçš„é æ¸¬è®Šæ•¸ More Predictors for Better Prediction
å¯¦å‹™ä¸Šæˆ‘å€‘å¯ä»¥è£½ä½œæ›´å¤šçš„é æ¸¬è®Šæ•¸ä¾†æé«˜æ¨¡å‹çš„é æ¸¬èƒ½åŠ›

#### åŒ¯æ•´ 2000-12-01 ~ 2001~02-28 é€™ä¸‰å€‹æœˆçš„è³‡æ–™ä¾†åšé æ¸¬è®Šæ•¸ 
```{r}
load("data/tf0.rdata")
d0 = max(X$date) + 1
B = X0 %>% 
  filter(date >= as.Date("2000-12-01")) %>% 
  mutate(days = as.integer(difftime(d0, date, units="days"))) %>% 
  group_by(cust) %>% summarise(
    r = min(days),      # recency
    s = max(days),      # seniority
    f = n(),            # frquency
    m = mean(total),    # monetary
    rev = sum(total),   # total revenue contribution
    raw = sum(gross),   # total gross profit contribution
    age = age[1],       # age group
    area = area[1],     # area code
  ) %>% data.frame      # 28531
nrow(B)
```

```{r}
normal_B = B[B$cust %in% normal$cust,]
new_B = B[B$cust %in% new$cust,]
silence_B = B[B$cust %in% silence$cust,]
highp_B = B[B$cust %in% highp$cust,]
longterm_B = B[B$cust %in% longterm$cust,]
```



```{r}
#B$Buy = predict(glm1, B, type="response")
normal_B$Buy = predict(glm_normal, normal_B, type="response")
new_B$Buy = predict(glm_new, new_B, type="response")
silence_B$Buy = predict(glm_silence, silence_B, type="response")
highp_B$Buy = predict(glm_highp, highp_B, type="response")
longterm_B$Buy = predict(glm_longterm, longterm_B, type="response")
```

#### Normal
```{r}
# normal_Bs = normal_B %>% mutate_at(c("m","rev"), log10)
# normal_B$Rev = 10^predict(normal_lm, normal_Bs)
# par(mfrow=c(1,2), cex=0.8)
# hist(normal_B$Buy)
# hist(log(normal_B$Rev,10))
```
#### New
```{r}
new_Bs = new_B %>% mutate_at(c("m","rev"), log10)
new_B$Rev = 10^predict(new_lm, new_Bs)
par(mfrow=c(1,2), cex=0.8)
hist(new_B$Buy)
hist(log(new_B$Rev,10))
```
#### Silence
```{r}
silence_Bs = silence_B %>% mutate_at(c("m","rev"), log10)
silence_B$Rev = 10^predict(silence_lm, silence_Bs)
par(mfrow=c(1,2), cex=0.8)
hist(silence_B$Buy)
hist(log(silence_B$Rev,10))
```
#### Highp
```{r}
highp_Bs = highp_B %>% mutate_at(c("m","rev"), log10)
highp_B$Rev = 10^predict(highp_lm, highp_Bs)
par(mfrow=c(1,2), cex=0.8)
hist(highp_B$Buy)
hist(log(highp_B$Rev,10))
```

#### Longterm
```{r}
longterm_Bs = longterm_B %>% mutate_at(c("m","rev"), log10)
longterm_B$Rev = 10^predict(longterm_lm, longterm_Bs)
par(mfrow=c(1,2), cex=0.8)
hist(longterm_B$Buy)
hist(log(longterm_B$Rev,10))
```

### 11. é¡§å®¢çµ‚ç”Ÿåƒ¹å€¼(CLV - Customer Live Time Value)
æ¥è‘—æˆ‘å€‘é€éè¨ˆç®—é¡§å®¢çµ‚ç”Ÿåƒ¹å€¼è®“æˆ‘å€‘äº†è§£æ¯ä¸€å€‹é¡§å®¢çš„æ½›åœ¨åƒ¹å€¼æœ‰å¤šå¤§ã€‚ Given one's retention probability and expected buying amount, CLV can be estimated via discounted cash flow.

<center>é¡§å®¢$i$çš„çµ‚ç”Ÿåƒ¹å€¼  (customer $i$'s CLV)</center>

$$ V_i = \sum_{t=0}^N g \times m_i \frac{r_i^t}{(1+d)^t} = g \times m_i \sum_{t=0}^N (\frac{r_i}{1+d})^t  $$

<center>$m_i$ã€$r_i$ï¼šé¡§å®¢$i$çš„é æœŸ(æ¯æœŸ)ç‡Ÿæ”¶è²¢ç»ã€ä¿ç•™æ©Ÿç‡</center>

<center>$g$ã€$d$ï¼šå…¬å¸çš„(ç¨…å‰)ç‡Ÿæ¥­åˆ©æ½¤åˆ©ç‡ã€è³‡é‡‘æˆæœ¬</center>

<br>

<center>$m_i$ï¼š$i$'s expected buying amount</center>

<center>$r_i$ï¼š$i$'s expected retention probability</center>

<center>$g$ã€$d$ï¼šcompany's operational margin rate</center>

<center>$g$ã€$d$ï¼šcompany's cost of capital</center>

#### Basic Assumption
```{r}
g = 0.3   # å¹³å‡æ¯›åˆ©ç‡
N = 36    # ä¼°è¨ˆCLVæœŸé–“(ä¸‰å¹´)
d = 0.01  # è³‡æœ¬åˆ©ç‡
```
#### Normal
```{r}
# normal_B$CLV = g * normal_B$Rev * rowSums(sapply(
#   0:N, function(i) (normal_B$Buy/(1+d))^i ) )
# summary(normal_B$CLV)
```

```{r fig.height=4}
# ggplot(normal_B, aes(CLV)) + 
#   geom_histogram(bins=30, fill="green",alpha=0.6) + 
#   scale_x_log10()
```
```{r}
# ggplot(normal_B, aes(CLV,color= age)) + 
#   geom_density(alpha=0.6) + 
#   scale_x_log10()
```


#### New
There're 2398 cust. <br>
```{r}
new_B$CLV = g * new_B$Rev * rowSums(sapply(
  0:N, function(i) (new_B$Buy/(1+d))^i ) )
summary(new_B$CLV)
```

```{r fig.height=4}
new1 =ggplot(new_B, aes(CLV)) + 
  geom_histogram(bins=30, fill="green",alpha=0.6) + 
  scale_x_log10()+ 
  ggtitle("new CLV")
ggplotly(new1)
```
```{r}
new2 = ggplot(new_B, aes(CLV,color= age)) + 
  geom_density(alpha=0.6) + 
  scale_x_log10()+ 
  ggtitle("new CLV by age")
ggplotly(new2)
```

```{r}
ggplot(new_B, aes(CLV)) + 
  geom_histogram(bins=30,alpha=0.6) + 
  scale_x_log10() +
  facet_wrap(~age)
```
```{r}
new_3 = ggplot(new_B, aes(CLV,color= area)) + 
  geom_density(alpha=0.6) + 
  scale_x_log10()+ 
  ggtitle("new CLV by area")
ggplotly(new_3)
```

```{r}
ggplot(new_B, aes(CLV)) + 
  geom_histogram(bins=30,alpha=0.6) + 
  scale_x_log10() +
  facet_wrap(~area)
```



#### Silence
There're 8299 cust. <br>
```{r}
silence_B$CLV = g * silence_B$Rev * rowSums(sapply(
  0:N, function(i) (silence_B$Buy/(1+d))^i ) )
summary(silence_B$CLV)
```

```{r fig.height=4}
silence1 = ggplot(silence_B, aes(CLV)) + 
  geom_histogram(bins=30, fill="green",alpha=0.6) + 
  scale_x_log10()+ 
  ggtitle("silence CLV")
ggplotly(silence1)
```
```{r}
silence2 = ggplot(silence_B, aes(CLV,color= age)) + 
  geom_density(alpha=0.6) + 
  scale_x_log10()+ 
  ggtitle("silence CLV by age")
ggplotly(silence2)
```

```{r}
ggplot(silence_B, aes(CLV)) + 
  geom_histogram(bins=30,alpha=0.6) + 
  scale_x_log10() +
  facet_wrap(~age)
```


```{r}
silence3 = ggplot(silence_B, aes(CLV,color= area)) + 
  geom_density(alpha=0.6) + 
  scale_x_log10()+ 
  ggtitle("silence CLV by area")
ggplotly(silence3)
```

```{r}
ggplot(silence_B, aes(CLV)) + 
  geom_histogram(bins=30,alpha=0.6) + 
  scale_x_log10() +
  facet_wrap(~area)
```

#### Highp
There're 12375 cust. <br>
```{r}
highp_B$CLV = g * highp_B$Rev * rowSums(sapply(
  0:N, function(i) (highp_B$Buy/(1+d))^i ) )
summary(highp_B$CLV)
```

```{r fig.height=4}
highp1 =ggplot(highp_B, aes(CLV)) + 
  geom_histogram(bins=30, fill="green",alpha=0.6) + 
  scale_x_log10()+ 
  ggtitle("highp CLV")
ggplotly(highp1)
```
```{r}
highp2 = ggplot(highp_B, aes(CLV,color= age)) + 
  geom_density(alpha=0.6) + 
  scale_x_log10()+ 
  ggtitle("highp CLV by age")
ggplotly(highp2)
```
```{r}
ggplot(highp_B, aes(CLV)) + 
  geom_histogram(bins=30,alpha=0.6) + 
  scale_x_log10() +
  facet_wrap(~age)
```

```{r}
highp_3 = ggplot(highp_B, aes(CLV,color= area)) + 
  geom_density(alpha=0.6) + 
  scale_x_log10()+ 
  ggtitle("highp CLV by area")
ggplotly(highp_3)
```

```{r}
ggplot(highp_B, aes(CLV)) + 
  geom_histogram(bins=30,alpha=0.6) + 
  scale_x_log10() +
  facet_wrap(~area)
```


#### Longterm
There're 1172 cust. <br>
```{r}
longterm_B$CLV = g * longterm_B$Rev * rowSums(sapply(
  0:N, function(i) (longterm_B$Buy/(1+d))^i ) )
summary(longterm_B$CLV)
```

```{r fig.height=4}
longterm1 = ggplot(longterm_B, aes(CLV)) + 
  geom_histogram(bins=30, fill="green",alpha=0.6) + 
  scale_x_log10()+ 
  ggtitle("longerm CLV")
ggplotly(longterm1)
```
```{r}
longterm2 = ggplot(longterm_B, aes(CLV,color= age)) + 
  geom_density(alpha=0.6) + 
  scale_x_log10()+ 
  ggtitle("longterm CLV by age")
ggplotly(longterm2)
```


```{r}
ggplot(longterm_B, aes(CLV)) + 
  geom_histogram(bins=30,alpha=0.6) + 
  scale_x_log10() +
  facet_wrap(~age)
```


```{r}
longterm_3 = ggplot(longterm_B, aes(CLV,color= area)) + 
  geom_density(alpha=0.6) + 
  scale_x_log10()+ 
  ggtitle("longterm CLV by area")
ggplotly(longterm_3)
```

```{r}
ggplot(longterm_B, aes(CLV)) + 
  geom_histogram(bins=30,alpha=0.6) + 
  scale_x_log10() +
  facet_wrap(~area)
```

### 12. ä½¿ç”¨æ¨¡å‹åšé æ¸¬ Utilizing Model for Prediction 

+ `Buy` : é æœŸå†è³¼æ©Ÿç‡ Re-Purchase Probability
+ `Rev` : é æœŸè³¼è²·é‡‘é¡ Expected Revenue Contribution

#### New
```{r fig.height=2.4, fig.width=7.2}
par(mfrow=c(1,2), cex=0.8)
hist(new_B$Buy)
hist(log(new_B$Rev,10))
```

```{r}
group_by(new_B,age) %>% 
  summarise(n=n(), Buy=mean(Buy), Rev=mean(Rev)) %>% 
  ggplot(aes(Buy,Rev,size=n,label=age)) + 
  geom_point(alpha=0.5,aes(col=age)) + 
  geom_text(size=4) +  
  labs(title="Age Group Comparison - New(size: no. customers)") +
  xlab("Avg. Buying Probability") + ylab("Avg. Expected Revenue") +
  scale_size(range=c(4,20)) + 
  theme_bw()  +     
  geom_vline(xintercept = sum(new_B$Buy)/length(new_B$Buy), col="purple", linetype = "dashed")+
  geom_hline(yintercept = sum(new_B$Rev)/length(new_B$Rev), col="darkcyan", linetype="dashed")   -> p
ggplotly(p)
```
#### Silence
```{r fig.height=2.4, fig.width=7.2}
par(mfrow=c(1,2), cex=0.8)
hist(silence_B$Buy)
hist(log(silence_B$Rev,10))
```

```{r}
group_by(silence_B,age) %>% 
  summarise(n=n(), Buy=mean(Buy), Rev=mean(Rev)) %>% 
  ggplot(aes(Buy,Rev,size=n,label=age)) + 
  geom_point(alpha=0.5,aes(col=age)) + 
  geom_text(size=4) + 
  labs(title="Age Group Comparison - Silence(size: no. customers)") +
  xlab("Avg. Buying Probability") + ylab("Avg. Expected Revenue") +
  scale_size(range=c(4,20)) + theme_bw() +
  geom_vline(xintercept = sum(silence_B$Buy)/length(silence_B$Buy), col="purple", linetype = "dashed")+
  geom_hline(yintercept = sum(silence_B$Rev)/length(silence_B$Rev), col="darkcyan", linetype="dashed")   -> p
ggplotly(p)
```

#### Highp
```{r fig.height=2.4, fig.width=7.2}
par(mfrow=c(1,2), cex=0.8)
hist(highp_B$Buy)
hist(log(highp_B$Rev,10))
```

```{r}
group_by(highp_B,age) %>% 
  summarise(n=n(), Buy=mean(Buy), Rev=mean(Rev)) %>% 
  ggplot(aes(Buy,Rev,size=n,label=age)) + 
  geom_point(alpha=0.5,aes(col=age)) + 
  geom_text(size=4) + 
  labs(title="Age Group Comparison - Highp(size: no. customers)") +
  xlab("Avg. Buying Probability") + ylab("Avg. Expected Revenue") +
  scale_size(range=c(4,20)) + theme_bw() +
  geom_vline(xintercept = sum(highp_B$Buy)/length(highp_B$Buy), col="purple", linetype = "dashed")+
  geom_hline(yintercept = sum(highp_B$Rev)/length(highp_B$Rev), col="darkcyan", linetype="dashed")   -> p
ggplotly(p)
```

#### Longterm
```{r fig.height=2.4, fig.width=7.2}
par(mfrow=c(1,2), cex=0.8)
hist(longterm_B$Buy)
hist(log(longterm_B$Rev,10))
```

```{r}
group_by(longterm_B,age) %>% 
  summarise(n=n(), Buy=mean(Buy), Rev=mean(Rev)) %>% 
  ggplot(aes(Buy,Rev,size=n,label=age)) + 
  geom_point(alpha=0.5,aes(col=age)) + 
  geom_text(size=4) + 
  labs(title="Age Group Comparison - Longterm(size: no. customers)") +
  xlab("Avg. Buying Probability") + ylab("Avg. Expected Revenue") +
  scale_size(range=c(4,20)) + 
  theme_bw()+
  geom_vline(xintercept = sum(longterm_B$Buy)/length(longterm_B$Buy), col="purple", linetype = "dashed")+
  geom_hline(yintercept = sum(longterm_B$Rev)/length(longterm_B$Rev), col="darkcyan", linetype="dashed")   -> p
ggplotly(p)
```
<br><hr>

### 13. æˆæœ¬æ•ˆç›Šå‡½æ•¸ - å¸¶åƒæ•¸çš„å‡è¨­ Cost Benefit Analysis

##### Â§ Sæ›²ç·š (S-Curve)

ğŸŒ» <z>S-Curve</z> : è¨±å¤šç®¡ç†å·¥å…·éƒ½å‘ˆç¾Så‹çš„æˆæœ¬æ•ˆç›Šå‡½æ•¸ 

ğŸŒ» æˆ‘å€‘å¯ä»¥ç”¨Rå…§å»ºçš„é‚è¼¯å¼å‡½æ•¸(`plogis()`)ä¾†æ¨¡æ“¬Sæ›²ç·š
$$\Delta P(x|m,b,a) = m \cdot Logis(\frac{10(x - b)}{a})$$
```{r fig.height=3}
DP = function(x,m0,b0,a0) {m0*plogis((10/a0)*(x-b0))}
# X = æˆæœ¬/ delta P = è³¼è²·æ•ˆç›Š
# DP = æ©Ÿç‡å¢å¹…
# Sæ›²ç·š:ç”¨æ„å–®ä¸€å‡½æ•¸ï¼Œä¾†è¡¡é‡å€‹è¡ŒéŠ·å·¥å…·çš„æˆæœ¬æ•ˆç›Š
#èª¿æ•´m,b,aï¼Œå³æ˜¯èª¿æ•´ä¸åŒçš„å·¥å…·ï¼Œæˆ–åŒä¸€(ä¸åŒ)å·¥å…·å°ä¸åŒæ—ç¾¤çš„æˆæœ¬æ•ˆç›Šé—œä¿‚
```

<br>

##### Â§ **å¸¶åƒæ•¸**çš„æˆæœ¬æ•ˆç›Šå‡½æ•¸ (Sæ›²ç·š)

ğŸŒ» <z>parameters(åƒæ•¸)</z>å¯ä»¥å¸¶å…¥å½ˆæ€§ï¼Œæ”¾å¯¬æ¨¡æ“¬çš„ç¯„åœ

![](fig/EffectFunition.png)

ğŸŒ» é€éé€™3å€‹<z>parameters(åƒæ•¸)</z>:

+ `m` : æœ€å¤§æ•ˆæœ 
+ `b` : æ•ˆæœçš„ä½ç½®(ä¸Šå‡æ³¢æ®µçš„ä¸­é»)*bè¶Šå¤§æˆæœ¬è¶Šé«˜ã€æ•ˆç›Šè¶Šä½  
+ `a` : æ•ˆæœçš„ç¯„åœ(ä¸Šå‡æ³¢æ®µçš„å¯¬åº¦) 

æˆ‘å€‘å¯ä»¥å¯«ã€ä¸€æ”¯ç¨‹å¼ã€ä¾†æ¨¡æ“¬ã€æ‰€æœ‰å¯èƒ½ã€çš„<z>æˆæœ¬æ•ˆç›Šå‡½æ•¸</z>(Sæ›²ç·š)<br>
è—‰ä»¥æè¿°<z>ç­–ç•¥è®Šæ•¸</z>($x$,æŠ˜åƒ¹å·é¢é¡)å’Œ<z>ç­–ç•¥æ•ˆæœ</z>($\Delta P$,è³¼è²·æ©Ÿç‡å¢å¹…)ä¹‹é–“çš„é—œä¿‚

<br>

##### Â§ ä¼°è¨ˆé æœŸç²åˆ©

æœ‰äº†è¡ŒéŠ·å·¥å…·çš„æˆæœ¬æ•ˆç›Šå‡½æ•¸ä¹‹å¾Œï¼Œæˆ‘å€‘å°±å¯ä»¥ä¼°è¨ˆå°‡é€™å€‹å·¥å…·ç”¨åœ¨æ¯ä¸€ä½é¡§å®¢ä¸Šçš„æ™‚å€™çš„é æœŸæ•ˆç›Š:

$$\hat{R}(x) = \left\{\begin{matrix}
\Delta P \cdot M \cdot margin - x & , & P + \Delta P \leq 1\\ 
(1-P) \cdot M \cdot margin - x & , & else 
\end{matrix}\right.$$

ğŸŒ» çµåˆ  ...

+ é æ¸¬ ($P, M$) : æ¯ä½é¡§å®¢çš„é æœŸè³¼è²·æ©Ÿç‡å’Œè³¼è²·é‡‘é¡ï¼Œèˆ‡
+ å‡è¨­ ($\Delta P(x|m,b,a)$) : è¡ŒéŠ·å·¥å…·å¸¶ä¾†çš„å†è³¼æ©Ÿç‡å¢é¡

æˆ‘å€‘å°±å¯ä»¥ä¼°è¨ˆé€™å€‹å·¥å…·ç”¨åœ¨æ¯ä½é¡§å®¢ä¸Šçš„é æœŸæ•ˆç›Š $\hat{R}(x)$ã€‚ 


ğŸŒ» Note that both $\Delta P$ and $\hat{R}$ are functions of $x$ given $m,b,a$

+ $P, M$ é æœŸè³¼è²·æ©Ÿç‡å’Œé‡‘é¡ï¼Œæ˜¯<z>é æ¸¬</z>
+ $Margin, X$ åˆ©æ½¤ç‡å’Œæˆæœ¬
+ $m, b, a$ è¡ŒéŠ·å·¥å…·çš„å±¬æ€§ï¼Œæ˜¯<z>å‡è¨­</z>
+ $x$ è¡ŒéŠ·å¼·åº¦ï¼Œæ˜¯æˆ‘å€‘å¯ä»¥æ“ä½œçš„ã€æƒ³è¦å„ªåŒ–çš„<z>ç­–ç•¥è®Šæ•¸</z>

<br>

#### New
**ä¼°è¨ˆæ¯›åˆ©ç‡** $m$
```{r}
# load(data/tf0.rdata)
# group_by(Z0, age) %>% summarise(sum(price)/sum(cost) - 1)
margin = 0.17  # assume margin = 0.17
```

**ä¼°è¨ˆæ¯ä½é¡§å®¢çš„æ·¨æ”¶ç›Š** $\hat{R}(x)$
```{r fig.height=3}
m=0.2; b=25; a=40; x=30
new_dp = pmin(1-new_B$Buy, DP(x,m,b,a)) # æ©Ÿç‡å¢å¹…ä¸å¯ä»¥è¶…é1ï¼Œæœ‰äº›äººæœ¬ä¾†çš„è³¼è²·æ©Ÿç‡å°±å·²ç¶“95%ï¼Œå¦‚æœå¢åŠ 0.15æœƒè¶…é1ï¼Œæ‰€ä»¥è©²è³¼è²·è€…æœ€å¤šåªèƒ½å¢åŠ 0.05ï¼Œå› æ­¤æ‰æ˜¯1-B$Buy, DP(x,m,b,a)ï¼Œå–æœ€å°
new_eR = new_dp*new_B$Rev*margin - x
# eR = Expected return = æ©Ÿç‡å¢å¹…*é æœŸç‡Ÿæ”¶(Rev)*åˆ©æ½¤ç‡ - æˆæœ¬
hist(log(new_eR),main="é æœŸæ·¨æ”¶ç›Šåˆ†ä½ˆ",xlab="é æœŸæ·¨æ”¶ç›Š",ylab="é¡§å®¢äººæ•¸",col = "lightblue")
```


#### Silence
**ä¼°è¨ˆæ¯›åˆ©ç‡** $m$
```{r}
# load(data/tf0.rdata)
# group_by(Z0, age) %>% summarise(sum(price)/sum(cost) - 1)
margin = 0.17  # assume margin = 0.17
```

**ä¼°è¨ˆæ¯ä½é¡§å®¢çš„æ·¨æ”¶ç›Š** $\hat{R}(x)$
```{r fig.height=3}
m=0.2; b=25; a=40; x=30
silence_dp = pmin(1-silence_B$Buy, DP(x,m,b,a)) # æ©Ÿç‡å¢å¹…ä¸å¯ä»¥è¶…é1ï¼Œæœ‰äº›äººæœ¬ä¾†çš„è³¼è²·æ©Ÿç‡å°±å·²ç¶“95%ï¼Œå¦‚æœå¢åŠ 0.15æœƒè¶…é1ï¼Œæ‰€ä»¥è©²è³¼è²·è€…æœ€å¤šåªèƒ½å¢åŠ 0.05ï¼Œå› æ­¤æ‰æ˜¯1-B$Buy, DP(x,m,b,a)ï¼Œå–æœ€å°
silence_eR = silence_dp*silence_B$Rev*margin - x
# eR = Expected return = æ©Ÿç‡å¢å¹…*é æœŸç‡Ÿæ”¶(Rev)*åˆ©æ½¤ç‡ - æˆæœ¬
hist(log(silence_eR),main="é æœŸæ·¨æ”¶ç›Šåˆ†ä½ˆ",xlab="é æœŸæ·¨æ”¶ç›Š",ylab="é¡§å®¢äººæ•¸",col = "lightblue")
```

#### Highp
**ä¼°è¨ˆæ¯›åˆ©ç‡** $m$
```{r}
# load(data/tf0.rdata)
# group_by(Z0, age) %>% summarise(sum(price)/sum(cost) - 1)
margin = 0.17  # assume margin = 0.17
```

**ä¼°è¨ˆæ¯ä½é¡§å®¢çš„æ·¨æ”¶ç›Š** $\hat{R}(x)$
```{r fig.height=3}
m=0.2; b=25; a=40; x=30
highp_dp = pmin(1-highp_B$Buy, DP(x,m,b,a)) # æ©Ÿç‡å¢å¹…ä¸å¯ä»¥è¶…é1ï¼Œæœ‰äº›äººæœ¬ä¾†çš„è³¼è²·æ©Ÿç‡å°±å·²ç¶“95%ï¼Œå¦‚æœå¢åŠ 0.15æœƒè¶…é1ï¼Œæ‰€ä»¥è©²è³¼è²·è€…æœ€å¤šåªèƒ½å¢åŠ 0.05ï¼Œå› æ­¤æ‰æ˜¯1-B$Buy, DP(x,m,b,a)ï¼Œå–æœ€å°
highp_eR = highp_dp*highp_B$Rev*margin - x
# eR = Expected return = æ©Ÿç‡å¢å¹…*é æœŸç‡Ÿæ”¶(Rev)*åˆ©æ½¤ç‡ - æˆæœ¬
hist(log(highp_eR),main="é æœŸæ·¨æ”¶ç›Šåˆ†ä½ˆ",xlab="é æœŸæ·¨æ”¶ç›Š",ylab="é¡§å®¢äººæ•¸",col = "lightblue")
```

#### Longterm
**ä¼°è¨ˆæ¯›åˆ©ç‡** $m$
```{r}
# load(data/tf0.rdata)
# group_by(Z0, age) %>% summarise(sum(price)/sum(cost) - 1)
margin = 0.17  # assume margin = 0.17
```

**ä¼°è¨ˆæ¯ä½é¡§å®¢çš„æ·¨æ”¶ç›Š** $\hat{R}(x)$
```{r fig.height=3}
m=0.2; b=25; a=40; x=30
longterm_dp = pmin(1-longterm_B$Buy, DP(x,m,b,a)) # æ©Ÿç‡å¢å¹…ä¸å¯ä»¥è¶…é1ï¼Œæœ‰äº›äººæœ¬ä¾†çš„è³¼è²·æ©Ÿç‡å°±å·²ç¶“95%ï¼Œå¦‚æœå¢åŠ 0.15æœƒè¶…é1ï¼Œæ‰€ä»¥è©²è³¼è²·è€…æœ€å¤šåªèƒ½å¢åŠ 0.05ï¼Œå› æ­¤æ‰æ˜¯1-B$Buy, DP(x,m,b,a)ï¼Œå–æœ€å°
longterm_eR = longterm_dp*longterm_B$Rev*margin - x
# eR = Expected return = æ©Ÿç‡å¢å¹…*é æœŸç‡Ÿæ”¶(Rev)*åˆ©æ½¤ç‡ - æˆæœ¬
hist(log(longterm_eR),main="é æœŸæ·¨æ”¶ç›Šåˆ†ä½ˆ",xlab="é æœŸæ·¨æ”¶ç›Š",ylab="é¡§å®¢äººæ•¸",col = "lightblue")
```
<br>

æ ¹æ“šä»¥ä¸Šçš„åˆ†æçµæœ ...

#### New
ğŸš´ æœ‰å¤šå°‘é¡§å®¢çš„æ·¨é æœŸå ±å„Ÿå¤§æ–¼é›¶ï¼Ÿ (`eR > 0`)?
```{r}
sum(new_eR>0)
```

ğŸš´ å¦‚æœæˆ‘å€‘é‡å°æ‰€æœ‰é¡§å®¢åšä¿ƒéŠ·ï¼Œç¸½é æœŸå ±å„Ÿå°‡æ˜¯ï¼Ÿ
```{r}
sum(new_eR)
```

ğŸš´ å¦‚æœæˆ‘å€‘é‡å°é æœŸå ±å„Ÿå¤§æ–¼é›¶çš„é¡§å®¢åšä¿ƒéŠ·ï¼Œé æœŸå ±å„Ÿå°‡æ˜¯ï¼Ÿ
```{r}
sum(new_eR[ new_eR>0 ])
# é¸æ“‡æ€§è¡ŒéŠ·è³ºä¸ƒè¬å¤š
```

ğŸš´ å¦‚æœæˆ‘å€‘åªé‡å°é æœŸå ±å„Ÿå¤§æ–¼10çš„é¡§å®¢åšä¿ƒéŠ·ï¼Œé æœŸå ±å„Ÿå°‡æ˜¯ï¼Ÿ
```{r}
sum(new_eR[ new_eR>10 ])
```

ğŸš´ å¦‚æœæˆ‘å€‘åªé‡å°é æœŸå ±å„Ÿå¤§æ–¼10çš„å—æ¸¯(`z115`)é¡§å®¢åšä¿ƒéŠ·ï¼Œé æœŸå ±å„Ÿå°‡æ˜¯ï¼Ÿ
```{r}
sum(new_eR[ new_eR>10 & new_B$area=="z115"])

```
ğŸš´å¦‚æœæˆ‘å€‘åªé‡å°é æœŸå ±å„Ÿå¤§æ–¼10çš„æ±æ­¢(`z221`)é¡§å®¢åšä¿ƒéŠ·ï¼Œé æœŸå ±å„Ÿå°‡æ˜¯ï¼Ÿ
```{r}
sum(new_eR[ new_eR>10 & new_B$area=="z221"])

```

#### Silence
ğŸš´ æœ‰å¤šå°‘é¡§å®¢çš„æ·¨é æœŸå ±å„Ÿå¤§æ–¼é›¶ï¼Ÿ (`eR > 0`)?
```{r}
sum(silence_eR>0)
```

ğŸš´ å¦‚æœæˆ‘å€‘é‡å°æ‰€æœ‰é¡§å®¢åšä¿ƒéŠ·ï¼Œç¸½é æœŸå ±å„Ÿå°‡æ˜¯ï¼Ÿ
```{r}
sum(silence_eR)
```

ğŸš´ å¦‚æœæˆ‘å€‘é‡å°é æœŸå ±å„Ÿå¤§æ–¼é›¶çš„é¡§å®¢åšä¿ƒéŠ·ï¼Œé æœŸå ±å„Ÿå°‡æ˜¯ï¼Ÿ
```{r}
sum(silence_eR[ silence_eR>0 ])
# é¸æ“‡æ€§è¡ŒéŠ·è³ºä¸ƒè¬å¤š
```

ğŸš´ å¦‚æœæˆ‘å€‘åªé‡å°é æœŸå ±å„Ÿå¤§æ–¼10çš„é¡§å®¢åšä¿ƒéŠ·ï¼Œé æœŸå ±å„Ÿå°‡æ˜¯ï¼Ÿ
```{r}
sum(silence_eR[ silence_eR>10 ])
```

ğŸš´ å¦‚æœæˆ‘å€‘åªé‡å°é æœŸå ±å„Ÿå¤§æ–¼10çš„å—æ¸¯(`z115`)é¡§å®¢åšä¿ƒéŠ·ï¼Œé æœŸå ±å„Ÿå°‡æ˜¯ï¼Ÿ
```{r}
sum(silence_eR[ silence_eR>10 & silence_B$area=="z115"   ])

```
ğŸš´å¦‚æœæˆ‘å€‘åªé‡å°é æœŸå ±å„Ÿå¤§æ–¼10çš„æ±æ­¢(`z221`)é¡§å®¢åšä¿ƒéŠ·ï¼Œé æœŸå ±å„Ÿå°‡æ˜¯ï¼Ÿ
```{r}
sum(silence_eR[ silence_eR>10 & silence_B$area=="z221"])

```

#### Highp
ğŸš´ æœ‰å¤šå°‘é¡§å®¢çš„æ·¨é æœŸå ±å„Ÿå¤§æ–¼é›¶ï¼Ÿ (`eR > 0`)?
```{r}
sum(highp_eR>0)
```

ğŸš´ å¦‚æœæˆ‘å€‘é‡å°æ‰€æœ‰é¡§å®¢åšä¿ƒéŠ·ï¼Œç¸½é æœŸå ±å„Ÿå°‡æ˜¯ï¼Ÿ
```{r}
sum(highp_eR)
```

ğŸš´ å¦‚æœæˆ‘å€‘é‡å°é æœŸå ±å„Ÿå¤§æ–¼é›¶çš„é¡§å®¢åšä¿ƒéŠ·ï¼Œé æœŸå ±å„Ÿå°‡æ˜¯ï¼Ÿ
```{r}
sum(highp_eR[ highp_eR>0 ])
# é¸æ“‡æ€§è¡ŒéŠ·è³ºä¸ƒè¬å¤š
```

ğŸš´ å¦‚æœæˆ‘å€‘åªé‡å°é æœŸå ±å„Ÿå¤§æ–¼10çš„é¡§å®¢åšä¿ƒéŠ·ï¼Œé æœŸå ±å„Ÿå°‡æ˜¯ï¼Ÿ
```{r}
sum(highp_eR[ highp_eR>10 ])
```

ğŸš´ å¦‚æœæˆ‘å€‘åªé‡å°é æœŸå ±å„Ÿå¤§æ–¼10çš„å—æ¸¯(`z115`)é¡§å®¢åšä¿ƒéŠ·ï¼Œé æœŸå ±å„Ÿå°‡æ˜¯ï¼Ÿ
```{r}
sum(highp_eR[ highp_eR>10 & highp_B$area=="z115"   ])

```
ğŸš´å¦‚æœæˆ‘å€‘åªé‡å°é æœŸå ±å„Ÿå¤§æ–¼10çš„æ±æ­¢(`z221`)é¡§å®¢åšä¿ƒéŠ·ï¼Œé æœŸå ±å„Ÿå°‡æ˜¯ï¼Ÿ
```{r}
sum(highp_eR[highp_eR>10 & highp_B$area=="z221"])

```

#### Longterm
ğŸš´ æœ‰å¤šå°‘é¡§å®¢çš„æ·¨é æœŸå ±å„Ÿå¤§æ–¼é›¶ï¼Ÿ (`eR > 0`)?
```{r}
sum(longterm_eR>0)
```

ğŸš´ å¦‚æœæˆ‘å€‘é‡å°æ‰€æœ‰é¡§å®¢åšä¿ƒéŠ·ï¼Œç¸½é æœŸå ±å„Ÿå°‡æ˜¯ï¼Ÿ
```{r}
sum(longterm_eR)
```

ğŸš´ å¦‚æœæˆ‘å€‘é‡å°é æœŸå ±å„Ÿå¤§æ–¼é›¶çš„é¡§å®¢åšä¿ƒéŠ·ï¼Œé æœŸå ±å„Ÿå°‡æ˜¯ï¼Ÿ
```{r}
sum(longterm_eR[ longterm_eR>0 ])
# é¸æ“‡æ€§è¡ŒéŠ·è³ºä¸ƒè¬å¤š
```

ğŸš´ å¦‚æœæˆ‘å€‘åªé‡å°é æœŸå ±å„Ÿå¤§æ–¼10çš„é¡§å®¢åšä¿ƒéŠ·ï¼Œé æœŸå ±å„Ÿå°‡æ˜¯ï¼Ÿ
```{r}
sum(longterm_eR[ longterm_eR>10 ])
```

ğŸš´ å¦‚æœæˆ‘å€‘åªé‡å°é æœŸå ±å„Ÿå¤§æ–¼10çš„å—æ¸¯(`z115`)é¡§å®¢åšä¿ƒéŠ·ï¼Œé æœŸå ±å„Ÿå°‡æ˜¯ï¼Ÿ
```{r}
sum(longterm_eR[ longterm_eR>10 & longterm_B$area=="z115"   ])

```
ğŸš´å¦‚æœæˆ‘å€‘åªé‡å°é æœŸå ±å„Ÿå¤§æ–¼10çš„æ±æ­¢(`z221`)é¡§å®¢åšä¿ƒéŠ·ï¼Œé æœŸå ±å„Ÿå°‡æ˜¯ï¼Ÿ
```{r}
sum(longterm_eR[ longterm_eR>10 & longterm_B$area=="z221"])

```
<br><hr>



### 14.ç­–ç•¥å¸‚å ´æ¨¡æ“¬(é‡æ–°è¨­åƒæ•¸!!) Simulate Marketing Strategies

çµ¦å®šå·¥å…·åƒæ•¸($m,b,a$)ï¼Œæˆ‘å€‘å¯åœ¨å…¶æœ‰æ•ˆæˆæœ¬ç¯„åœ($x \in [b-\frac{a}{2}, b+\frac{a}{2}]$)ä¹‹å…§ï¼Œä¼°è¨ˆå·¥å…·çš„æ•ˆæœï¼š

+ `eReturn` : å°æ‰€æœ‰çš„äººè¡ŒéŠ·çš„ç¸½é æœŸæ”¶ç›Š
+ `N` : é æœŸæ”¶ç›Šå¤§æ–¼é›¶çš„äººæ•¸
+ `eReturn2` : åªå°æœŸæ”¶ç›Šå¤§æ–¼é›¶çš„äººåšè¡ŒéŠ·çš„ç¸½é æœŸæ”¶ç›Š

å¦‚ä½•éš¨æˆæœ¬è®ŠåŒ–ã€‚

##### Â§ å¤šå€‹è¡ŒéŠ·å·¥å…·

ç¨å¾®æ”¹ä¸€ä¸‹ç¨‹å¼ï¼Œæˆ‘å€‘å¯ä»¥åŒæ™‚æ¨¡æ“¬å¤š(4)å€‹è¡ŒéŠ·å·¥å…·ï¼Œä¸¦æ¯”è¼ƒä»–å€‘çš„æˆæœ¬æ•ˆç›Š
With some modification of the code, we can define multiple (4) instruments 

```{r fig.height=3, fig.width=7}
mm=c(0.20, 0.25, 0.15, 0.25)
bb=c(  25,   30,   15,   30)
aa=c(  40,   40,   30,   60) 
X = seq(0,60,2) 
do.call(rbind, lapply(1:length(mm), function(i) data.frame(
  Inst=paste0('Inst',i), Cost=X, 
  Gain=DP(X,mm[i],bb[i],aa[i])
  ))) %>% data.frame %>% 
  ggplot(aes(x=Cost, y=Gain, col=Inst)) +
  geom_line(size=1.5,alpha=0.5) + theme_bw() +
  ggtitle("Prob. Function: f(x|m,b,a)")
```

and run simulation on multiple instrument to compare their cost effectiveness. 

#### New
```{r warning=F, fig.height=8, fig.width=8}
X = seq(10, 60, 1) 
new_df = do.call(rbind, lapply(1:length(mm), function(i) {
  sapply(X, function(x) {
    new_dp = pmin(1-new_B$Buy, DP(x,mm[i],bb[i],aa[i]))
    new_eR = new_dp*new_B$Rev*margin - x
    c(i=i, x=x, eR.ALL=sum(new_eR), N=sum(new_eR>0), eR.SEL=sum(new_eR[new_eR > 0]) )
    }) %>% t %>% data.frame
  })) 
# i : å·¥å…·ç·¨è™Ÿ
new_df %>% 
  mutate_at(vars(eR.ALL, eR.SEL), function(y) round(y/1000)) %>% 
  gather('key','value',-i,-x) %>% 
  mutate(Instrument = paste0('I',i)) %>%
  ggplot(aes(x=x, y=value, col=Instrument)) + 
  geom_hline(yintercept=0, linetype='dashed', col='blue') +
  geom_line(size=1.5,alpha=0.5) + 
  xlab('å·¥å…·é¸é …(æˆæœ¬)') + ylab('é æœŸæ”¶ç›Š($K)') + 
  ggtitle('è¡ŒéŠ·å·¥å…·å„ªåŒ–','å‡è¨­è¡ŒéŠ·å·¥å…·çš„æ•ˆæœæ˜¯å…¶æˆæœ¬çš„å‡½æ•¸') +
    facet_wrap(~key,ncol=1,scales='free_y') + theme_bw() -> new_p

plotly::ggplotly(new_p)
```
```{r}
group_by(new_df, i) %>% top_n(1,eR.SEL)
```


#### Silence
```{r warning=F, fig.height=8, fig.width=8}
X = seq(10, 60, 1) 
silence_df = do.call(rbind, lapply(1:length(mm), function(i) {
  sapply(X, function(x) {
    silence_dp = pmin(1-silence_B$Buy, DP(x,mm[i],bb[i],aa[i]))
    silence_eR = silence_dp*silence_B$Rev*margin - x
    c(i=i, x=x, eR.ALL=sum(silence_eR), N=sum(silence_eR>0), eR.SEL=sum(silence_eR[silence_eR > 0]) )
    }) %>% t %>% data.frame
  })) 
# i : å·¥å…·ç·¨è™Ÿ
silence_df %>% 
  mutate_at(vars(eR.ALL, eR.SEL), function(y) round(y/1000)) %>% 
  gather('key','value',-i,-x) %>% 
  mutate(Instrument = paste0('I',i)) %>%
  ggplot(aes(x=x, y=value, col=Instrument)) + 
  geom_hline(yintercept=0, linetype='dashed', col='blue') +
  geom_line(size=1.5,alpha=0.5) + 
  xlab('å·¥å…·é¸é …(æˆæœ¬)') + ylab('é æœŸæ”¶ç›Š($K)') + 
  ggtitle('è¡ŒéŠ·å·¥å…·å„ªåŒ–','å‡è¨­è¡ŒéŠ·å·¥å…·çš„æ•ˆæœæ˜¯å…¶æˆæœ¬çš„å‡½æ•¸') +
    facet_wrap(~key,ncol=1,scales='free_y') + theme_bw() -> silence_p

plotly::ggplotly(silence_p)
```
```{r}
group_by(silence_df, i) %>% top_n(1,eR.SEL)
```

#### Highp
```{r warning=F, fig.height=8, fig.width=8}
X = seq(10, 60, 1) 
highp_df = do.call(rbind, lapply(1:length(mm), function(i) {
  sapply(X, function(x) {
    highp_dp = pmin(1-highp_B$Buy, DP(x,mm[i],bb[i],aa[i]))
    highp_eR = highp_dp*highp_B$Rev*margin - x
    c(i=i, x=x, eR.ALL=sum(highp_eR), N=sum(highp_eR>0), eR.SEL=sum(highp_eR[highp_eR > 0]) )
    }) %>% t %>% data.frame
  })) 
# i : å·¥å…·ç·¨è™Ÿ
highp_df %>% 
  mutate_at(vars(eR.ALL, eR.SEL), function(y) round(y/1000)) %>% 
  gather('key','value',-i,-x) %>% 
  mutate(Instrument = paste0('I',i)) %>%
  ggplot(aes(x=x, y=value, col=Instrument)) + 
  geom_hline(yintercept=0, linetype='dashed', col='blue') +
  geom_line(size=1.5,alpha=0.5) + 
  xlab('å·¥å…·é¸é …(æˆæœ¬)') + ylab('é æœŸæ”¶ç›Š($K)') + 
  ggtitle('è¡ŒéŠ·å·¥å…·å„ªåŒ–','å‡è¨­è¡ŒéŠ·å·¥å…·çš„æ•ˆæœæ˜¯å…¶æˆæœ¬çš„å‡½æ•¸') +
    facet_wrap(~key,ncol=1,scales='free_y') + theme_bw() -> highp_p

plotly::ggplotly(highp_p)
```
```{r}
group_by(highp_df, i) %>% top_n(1,eR.SEL)
```

#### Longterm
```{r warning=F, fig.height=8, fig.width=8}
X = seq(10, 60, 1) 
longterm_df = do.call(rbind, lapply(1:length(mm), function(i) {
  sapply(X, function(x) {
    longterm_dp = pmin(1-longterm_B$Buy, DP(x,mm[i],bb[i],aa[i]))
    longterm_eR = longterm_dp*longterm_B$Rev*margin - x
    c(i=i, x=x, eR.ALL=sum(longterm_eR), N=sum(longterm_eR>0), eR.SEL=sum(longterm_eR[longterm_eR > 0]) )
    }) %>% t %>% data.frame
  })) 
# i : å·¥å…·ç·¨è™Ÿ
longterm_df %>% 
  mutate_at(vars(eR.ALL, eR.SEL), function(y) round(y/1000)) %>% 
  gather('key','value',-i,-x) %>% 
  mutate(Instrument = paste0('I',i)) %>%
  ggplot(aes(x=x, y=value, col=Instrument)) + 
  geom_hline(yintercept=0, linetype='dashed', col='blue') +
  geom_line(size=1.5,alpha=0.5) + 
  xlab('å·¥å…·é¸é …(æˆæœ¬)') + ylab('é æœŸæ”¶ç›Š($K)') + 
  ggtitle('è¡ŒéŠ·å·¥å…·å„ªåŒ–','å‡è¨­è¡ŒéŠ·å·¥å…·çš„æ•ˆæœæ˜¯å…¶æˆæœ¬çš„å‡½æ•¸') +
    facet_wrap(~key,ncol=1,scales='free_y') + theme_bw() -> longterm_p

plotly::ggplotly(longterm_p)
```

```{r}
group_by(longterm_df, i) %>% top_n(1,eR.SEL)
#åœ¨å„çµ„ä¸­æ‰¾é æœŸæ·¨å ±é…¬æœ€å¤§çš„
```

ğŸš´ å¾æ¨¡æ“¬çš„çµæœæˆ‘å€‘å¯ä»¥å¾ˆå®¹æ˜“çœ‹å‡ºæ¯ä¸€å€‹å·¥å…·çš„ï¼š

+ æœ€ä½³è¡ŒéŠ·å¼·åº¦
+ æœ€ä½³è¡ŒéŠ·å°è±¡äººæ•¸
+ æœ€ä½³é æœŸç²åˆ©

<br><br><hr>



```{r}
options(scipen=10)
pacman::p_load(latex2exp,Matrix,dplyr,tidyr,ggplot2,caTools,plotly,ggplot)
rm(list=ls(all=TRUE))
load("data/tf4.rdata")
```

```{r}
#A39 A44å¹´é½¡å…©ç¾¤
a39df<-B[B$age=="a39",c("cust","r","s","f","m","rev","raw","age","area","Buy","Rev")]
a44df<-B[B$age=="a44",c("cust","r","s","f","m","rev","raw","age","area","Buy","Rev")]
```

```{r}
DP = function(x,m0,b0,a0) {m0*plogis((10/a0)*(x-b0))}
margin = 0.17 
m=0.2; b=25; a=40; x=30
a39df_dp = pmin(1-a39df$Buy, DP(x,m,b,a)) # æ©Ÿç‡å¢å¹…ä¸å¯ä»¥è¶…é1ï¼Œæœ‰äº›äººæœ¬ä¾†çš„è³¼è²·æ©Ÿç‡å°±å·²ç¶“95%ï¼Œå¦‚æœå¢åŠ 0.15æœƒè¶…é1ï¼Œæ‰€ä»¥è©²è³¼è²·è€…æœ€å¤šåªèƒ½å¢åŠ 0.05ï¼Œå› æ­¤æ‰æ˜¯1-B$Buy, DP(x,m,b,a)ï¼Œå–æœ€å°
a39df_er = a39df_dp*a39df$Rev*margin - x
hist(log(a39df_er),main="é æœŸæ·¨æ”¶ç›Šåˆ†ä½ˆ",xlab="é æœŸæ·¨æ”¶ç›Š",ylab="é¡§å®¢äººæ•¸",col = "lightblue")
```

```{r}
m=0.2; b=25; a=40; X = seq(10,45,1)
df = sapply(X, function(x) {
  dp = pmin(DP(x,m,b,a),1-a39df$Buy)
  eR = dp*a39df$Rev*margin - x
  c(x=x, eReturn=sum(eR),N=sum(eR > 0), eReturn2=sum(eR[eR > 0]))
  }) %>% t %>% data.frame

df %>% gather('key','value',-x)%>% ggplot(aes(x=x, y=value, col=key)) + 
  geom_hline(yintercept=0,linetype='dashed') +
  geom_line(size=1.5,alpha=0.5) + 
  facet_wrap(~key,ncol=1,scales='free_y') + theme_bw()
```

```{r}
mm=c(0.3, 0.25)
bb=c(  35,   30)
aa=c(  20,   40) 
X = seq(0,60,2) 
do.call(rbind, lapply(1:length(mm), function(i) data.frame(
  Inst=paste0('Inst',i), Cost=X, 
  Gain=DP(X,mm[i],bb[i],aa[i])
  ))) %>% data.frame %>% 
  ggplot(aes(x=Cost, y=Gain, col=Inst)) +
  geom_line(size=1.5,alpha=0.5) + theme_bw() +
  ggtitle("Prob. Function: f(x|m,b,a)")
```


# A39
```{r}
X = seq(10, 60, 1) 
a39df = do.call(rbind, lapply(1:length(mm), function(i) {
  sapply(X, function(x) {
    a39dp = pmin(1-a39df$Buy, DP(x,mm[i],bb[i],aa[i]))
    a39eR = a39dp*a39df$rev*margin - x
    c(i=i, x=x, eR.ALL=sum(a39eR), N=sum(a39eR>0), eR.SEL=sum(a39eR[a39eR > 0]) )
    }) %>% t %>% data.frame
  }))



a39df %>% 
  mutate_at(vars(eR.ALL, eR.SEL), function(y) round(y/1000)) %>% 
  gather('key','value',-i,-x) %>% 
  mutate(Instrument = paste0('I',i)) %>%
  ggplot(aes(x=x, y=value, col=Instrument)) + 
  geom_hline(yintercept=0, linetype='dashed', col='blue') +
  geom_line(size=1.5,alpha=0.5) + 
  xlab('å·¥å…·é¸é …(æˆæœ¬)') + ylab('é æœŸæ”¶ç›Š($K)') + 
  ggtitle('è¡ŒéŠ·å·¥å…·å„ªåŒ–','å‡è¨­è¡ŒéŠ·å·¥å…·çš„æ•ˆæœæ˜¯å…¶æˆæœ¬çš„å‡½æ•¸') +
    facet_wrap(~key,ncol=1,scales='free_y') + theme_bw() -> a39_p

plotly::ggplotly(a39_p)
```


```{r}
group_by(a39df, i) %>% top_n(1,eR.SEL)
```

ç•¶æˆæœ¬ç‚º43æ™‚,é æœŸçš„æ”¶ç›Šæ˜¯42è¬å·¦å³,äººæ•¸ç´„4028ï¼Œmè¨­ä¸åŒæ™‚æœ‰ä¸åŒçš„æ•ˆæœ <br>
# A44

```{r}
X = seq(10, 60, 1) 
a44df = do.call(rbind, lapply(1:length(mm), function(i) {
  sapply(X, function(x) {
    a44dp = pmin(1-a44df$Buy, DP(x,mm[i],bb[i],aa[i]))
    a44eR = a44dp*a44df$rev*margin - x
    c(i=i, x=x, eR.ALL=sum(a44eR), N=sum(a44eR>0), eR.SEL=sum(a44eR[a44eR > 0]) )
    }) %>% t %>% data.frame
  }))


a44df %>% 
  mutate_at(vars(eR.ALL, eR.SEL), function(y) round(y/1000)) %>% 
  gather('key','value',-i,-x) %>% 
  mutate(Instrument = paste0('I',i)) %>%
  ggplot(aes(x=x, y=value, col=Instrument)) + 
  geom_hline(yintercept=0, linetype='dashed', col='blue') +
  geom_line(size=1.5,alpha=0.5) + 
  xlab('å·¥å…·é¸é …(æˆæœ¬)') + ylab('é æœŸæ”¶ç›Š($K)') + 
  ggtitle('è¡ŒéŠ·å·¥å…·å„ªåŒ–','å‡è¨­è¡ŒéŠ·å·¥å…·çš„æ•ˆæœæ˜¯å…¶æˆæœ¬çš„å‡½æ•¸') +
    facet_wrap(~key,ncol=1,scales='free_y') + theme_bw() -> a44_p

plotly::ggplotly(a44_p)
```

```{r}
group_by(a44df, i) %>% top_n(1,eR.SEL)
```

